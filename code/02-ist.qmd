# ist

## preamble

```{r load-deps, message=FALSE, warning=FALSE}
library(scuttle)
library(HDF5Array)
library(SingleCellExperiment)
source("code/_utils.R")
set.seed(251103)
```

## loading

```{r load-data}
(sce <- readRDS("outs/fil.rds"))
dim(pbs <- readRDS("outs/pbs.rds"))
```

## clustering

```{r echo=FALSE}
run <- !file.exists(out <- "outs/ist.rds")
```

```{r clu, eval=run, message=FALSE, warning=FALSE, results="hide"}
ist <- .ist(sce, pbs=pbs, nk=c(4, 8), ns=c(1e4, 2e4, 1e5)/2)
```

```{r echo=FALSE}
if (!run) ist <- readRDS(out) else saveRDS(ist, out)
```

```{r tbl}
ks <- intersect(letters, unique(ist$clust))
ks <- c(ks, sort(colnames(pbs)))
ist$clust <- factor(ist$clust, ks)
table(ist$clust); nlevels(ist$clust)
```

## visuals

```{r plt-fp, fig.width=3, fig.height=3.5}
.plt_fp(ist)
```

```{r plt-fq, fig.width=4, fig.height=3}
#| code-fold: true
sce$ist <- (kid <- ist$clust)[match(colnames(sce), names(kid))]
.plt_fq(sce, "sid", "ist", id="all", h=TRUE) + theme(aspect.ratio=1) 
```


::: {.panel-tabset}

```{r plt-de, results="asis", fig.width=8, fig.height=3}
ps <- .plt_de(ist, "all", n1=10, n2=80); names(ps)[1] <- "all"
for (. in names(ps)) {cat("###",.,"\n"); print(ps[[.]]); cat("\n\n")}
```

:::

## labeling

```{r lab}
lab <- list(
    tum=c("tum", "a", "b", "c", "g", "h"),
    nkt="nkt", mye=c("mye", "e"), str=c("d", "f"))
jst <- .jst(ist, lab)
table(ist$clust, jst$clust)
(ns <- table(jst$clust))
round(100*prop.table(ns), 2)
```

## appendix

### saving

```{r save-data}
saveRDS(ist, "outs/ist.rds")
saveRDS(jst, "outs/lv1.rds")
```

::: {.callout-note icon=false, collapse=true}

### session

```{r sess-info}
#| code-fold: false
sessionInfo()
```

:::