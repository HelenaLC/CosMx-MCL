# sig

## preamble

```{r load-deps, message=FALSE, warning=FALSE}
library(scran)
library(scater)
library(scuttle)
library(SingleCellExperiment)
source("code/_utils.R")
set.seed(251206)
```

## loading

```{r load-data}
(sce <- readRDS("outs/pro.rds"))
```

## analysis

```{r sig}
sig <- altExp(sce, "UCell")
# order contexts by tumor fraction
mu <- by(sig$fqs$tum, sig$ctx, mean)
xo_ctx <- scale_x_discrete(limits=names(mu)[order(mu)])
# order cores by proliferation proxy
mv <- by(assay(sig)["S-Phase", ], sig$sid, mean)
xo_sid <- scale_x_discrete(limits=names(mv)[order(mv)])
```

```{r echo=FALSE}
.plt_cor <- \(se) {
    pal <- rev(pals::brewer.puor(99))
    pheatmap::pheatmap(cor(t(assay(se))),
        main="inter-signature correlation",
        cellwidth=10, cellheight=10,
        treeheight_row=20, treeheight_col=20, 
        fontsize=9, color=pal, border_color=NA)
}
.plt_avg <- \(se, by) {
    df <- data.frame(t(assay(se)), colData(se), check.names=FALSE)
    fd <- pivot_longer(df, all_of(rownames(se)))
    mu <- fd |>
        group_by(name, !!sym(by)) |>
        summarise_at("value", mean) |>
        group_by(name) |>
        mutate_at("value", .z)
    mx <- pivot_wider(mu)
    my <- as.matrix(mx[, -1])
    rownames(my) <- mx[[1]]
    ggplot(mu, aes(.data[[by]], name, fill=value)) + geom_tile() +
        scale_fill_gradientn(
            "z-scaled\nmean UCell", 
            colors=rev(pals::brewer.puor(99)),
            limits=c(-2.5, 2.5), breaks=seq(-2, 2, 2)) +
        scale_x_discrete(limits=.xo(my)) +
        scale_y_discrete(limits=.yo(my)) +
        coord_equal(expand=FALSE) +
        .thm_fig_c("minimal") + theme(
            axis.title=element_blank(),
            axis.text.x=element_text(angle=90, hjust=1, vjust=0.5))
}
```

### nkt

```{r sig-nkt}
.sig <- sig[rowData(sig)$typ == "t-atlas", sig$lv1 == "nkt"]
```

```{r sig-nkt-cor, fig.width=10, fig.height=8}
#| code-fold: true
.plt_cor(.sig)
```

```{r fig.width=10, fig.height=4}
#| code-fold: true
.plt_avg(.sig, "lv2") + 
.plt_avg(.sig, "sid") + xo_sid +
.plt_avg(.sig, "ctx") + xo_ctx +
plot_layout(guides="collect")
```

### tum

```{r sig-tum}
.sig <- sig[rowData(sig)$typ != "t-atlas", sig$lv1 == "tum"]
```

```{r sig-tum-cor, fig.width=10, fig.height=8}
#| code-fold: true
.plt_cor(.sig)
```

```{r sig-tum-box, fig.width=12, fig.height=4}
#| code-fold: true
.plt_avg(.sig, "sid") + xo_sid +
.plt_avg(.sig, "ctx") + xo_ctx +
plot_layout(guides="collect")
```

## appendix

::: {.callout-note icon=false, collapse=true}

### session

```{r sess-info}
#| code-fold: false
sessionInfo()
```

:::
