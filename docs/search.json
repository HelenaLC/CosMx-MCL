[
  {
    "objectID": "code/index.html",
    "href": "code/index.html",
    "title": "toc",
    "section": "",
    "text": "toc\n\npseudobulks\nsetup\n\nadd core-level metadata\nwrite polygons to .parquet\nformat into SingleCellExperiment\nnegative & false codes as altExps\n\nfiltering\n\nbased on cell-level metrics\n& distance to FOV borders\n\nsignatures\n\nMSigDB, in-house, public\n& pan-cancer T cell atlas\n\nsignaling\n\nusing COMMOT\n\nclustering\n\nsemi-supervised for all but stromal\nsplit into NK/T, myeloid stromal & tumor cells\n\nsubclustering’’\n\nsemi-supervised for all but stroml\nsubset-specific feature selection\n\ncontexts\n\ncluster cells based on composition\nof 20um radial neighborhoods\n\nprocessing\n\npooling of all previousresults\ndimensionality reduction (joint & split)\n\nEDA signatures\nEDA signaling"
  },
  {
    "objectID": "code/00-ref.html",
    "href": "code/00-ref.html",
    "title": "ref",
    "section": "",
    "text": "library(qs)\nlibrary(Seurat)\nlibrary(scuttle)\nlibrary(SingleCellExperiment)\nsource(\"code/_utils.R\")\n\n\n\n\n\nqs &lt;- list.files(\"data/ref\", \"qs$\", full.names=TRUE)\nnames(qs) &lt;- gsub(\"\\\\.qs\", \"\", basename(qs))\nse &lt;- lapply(qs, \\(.) {\n    so &lt;- qread(.)\n    se &lt;- as.SingleCellExperiment(so)\n    logcounts(se) &lt;- NULL\n    reducedDims(se) &lt;- list()\n    gs &lt;- VariableFeatures(so)\n    gs &lt;- rownames(se) %in% gs\n    rowData(se)$hvg &lt;- gs\n    se\n}); sapply(se, ncol)\n\n   mye    nkt    tum \n 48047 174677 151264 \n\n\n\n\n\n\nold &lt;- c(\"0\",\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"11\")\nnew &lt;- c(\n    \"Classical_monocytes\", \"Class. monocytes_HLA\", \n    \"Non-class. monocytes\", \"Class. monocytes_SELL\", \n    \"Class. monocytes_ribo\", \"DC2\", \"Class. monocytes_IFNresp\", \n    \"pDC_1\", \"Progenitor cells\", \"Platelets\", \"pDC_2\", \"DC1\")\nnev &lt;- list(\n    mono.c=c(\"Classical_monocytes\",\n        \"Class. monocytes_SELL\", \"Class. monocytes_HLA\",\n        \"Class. monocytes_ribo\", \"Class. monocytes_IFNresp\"),\n    mono.nc=\"Non-class. monocytes\",\n    pDC=c(\"pDC_2\", \"pDC_1\"),\n    DC=c(\"DC1\", \"DC2\"))\nnev &lt;- setNames(rep.int(names(nev), sapply(nev, length)), unlist(nev))\nlab &lt;- new[match(se$mye$ident, old)]\nlab &lt;- nev[match(lab, names(nev))]\ntable(se$mye$lab &lt;- lab, exclude=NULL)\n\n\n     DC  mono.c mono.nc     pDC    &lt;NA&gt; \n   3141   32819    8632    2230    1225 \n\n\n\nold &lt;- c(\"0\",\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"11\",\"12\",\"13\",\"14\",\"15\",\"17\",\"18\")\nnew &lt;- c(\n    \"CD16pos NK\",\"CD4 TCM TFH\",\"TEMRA\",\"CD4 TN\",\"CD8 TPEX\",\"CD4 TREG\",\n    \"CD4 TCM TH2\",\"NK-like T\",\"NK/ILC\",\"CD8 TEX\",\"CD4 TCM\",\"CD8 TEM\",\n    \"CD16neg NK\",\"CD8 TN\",\"MAIT\",\"Cycling T\",\"IFN responding\")\nnev &lt;- list(\n    \"NK/ILC\"=c(\"CD16neg NK\", \"CD16pos NK\", \"NK ILC3\"),\n    Tcm=c(\"CD4 TCM_TH2\", \"CD4 TCM\"),\n    Tex=c(\"CD8 TPEX\", \"CD8 TEX\"),\n    Tc=c(\"CD8 TEM\", \"TEMRA\"),\n    Tfh=\"CD4 TCM TFH\",\n    Treg=\"CD4 TREG\",\n    Tp=\"Cycling T\",\n    Thn=\"CD4 TN\",\n    Tcn=\"CD8 TN\")\nnev &lt;- setNames(rep.int(names(nev), sapply(nev, length)), unlist(nev))\nlab &lt;- new[match(se$nkt$ident, old)]\nlab &lt;- nev[match(lab, names(nev))]\ntable(se$nkt$lab &lt;- lab, exclude=NULL)\n\n\nNK/ILC     Tc    Tcm    Tcn    Tex    Tfh    Thn     Tp   Treg   &lt;NA&gt; \n 31217  22652   5570   4312  24062  25102  21647   2900  12270  24945 \n\n\n\n\n\n\ngs &lt;- Reduce(intersect, lapply(se, rownames))\nmx &lt;- do.call(cbind, lapply(se, \\(.) assay(.)[gs, ]))\ndim(mx &lt;- normalizeCounts(mx, log=FALSE))\n\n[1]  36190 373988\n\n\n\n\n\n\n\n\nid &lt;- rep.int(names(se), sapply(se, ncol))\npb &lt;- summarizeAssayByGroup(mx, id, statistics=\"mean\")\nhead(pb &lt;- assay(pb))\n\n                     mye          nkt          tum\nMIR1302-2HG 0.000000e+00 5.128928e-06 6.104829e-05\nFAM138A     0.000000e+00 0.000000e+00 0.000000e+00\nOR4F5       0.000000e+00 0.000000e+00 0.000000e+00\nAL627309.1  2.167347e-03 8.358290e-04 1.458888e-03\nAL627309.3  2.226803e-05 2.605354e-05 4.804775e-05\nAL627309.2  5.940144e-05 0.000000e+00 0.000000e+00\n\n\n\n\n\n\nqb &lt;- lapply(se, \\(.) {\n    if (is.null(id &lt;- .$lab)) return()\n    cs &lt;- colnames(.)[!(ex &lt;- is.na(id))]\n    summarizeAssayByGroup(mx[, cs], id[!ex], statistics=\"mean\")\n})\nqb &lt;- qb[!sapply(qb, is.null)]\nqb &lt;- lapply(qb, assay)\nsapply(qb, colnames)\n\n$mye\n[1] \"DC\"      \"mono.c\"  \"mono.nc\" \"pDC\"    \n\n$nkt\n[1] \"NK/ILC\" \"Tc\"     \"Tcm\"    \"Tcn\"    \"Tex\"    \"Tfh\"    \"Thn\"    \"Tp\"    \n[9] \"Treg\"  \n\n\n\n\n\n\n\n\n\nsaveRDS(pb, \"outs/pbs.rds\")\nsaveRDS(qb, \"outs/qbs.rds\")\n\n\n\n\n\n\n\nsession\n\n\n\n\n\n\nsessionInfo()\n\nR version 4.5.1 (2025-06-13)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS Sequoia 15.6.1\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Europe/Madrid\ntzcode source: internal\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] patchwork_1.3.2             ggplot2_4.0.0              \n [3] tidyr_1.3.1                 dplyr_1.1.4                \n [5] scuttle_1.18.0              SingleCellExperiment_1.30.1\n [7] SummarizedExperiment_1.38.1 Biobase_2.68.0             \n [9] GenomicRanges_1.60.0        GenomeInfoDb_1.44.3        \n[11] IRanges_2.42.0              S4Vectors_0.46.0           \n[13] BiocGenerics_0.54.1         generics_0.1.4             \n[15] MatrixGenerics_1.20.0       matrixStats_1.5.0          \n[17] Seurat_5.3.1                SeuratObject_5.2.0         \n[19] sp_2.2-0                    qs_0.27.3                  \n\nloaded via a namespace (and not attached):\n  [1] RColorBrewer_1.1-3      rstudioapi_0.17.1       jsonlite_2.0.0         \n  [4] magrittr_2.0.4          spatstat.utils_3.2-0    farver_2.1.2           \n  [7] rmarkdown_2.30          vctrs_0.6.5             ROCR_1.0-11            \n [10] spatstat.explore_3.5-3  S4Arrays_1.8.1          htmltools_0.5.8.1      \n [13] SparseArray_1.8.1       sctransform_0.4.2       parallelly_1.45.1      \n [16] KernSmooth_2.23-26      htmlwidgets_1.6.4       ica_1.0-3              \n [19] plyr_1.8.9              plotly_4.11.0           zoo_1.8-14             \n [22] igraph_2.2.1            mime_0.13               lifecycle_1.0.4        \n [25] pkgconfig_2.0.3         Matrix_1.7-4            R6_2.6.1               \n [28] fastmap_1.2.0           GenomeInfoDbData_1.2.14 fitdistrplus_1.2-4     \n [31] future_1.67.0           shiny_1.11.1            digest_0.6.37          \n [34] colorspace_2.1-2        tensor_1.5.1            RSpectra_0.16-2        \n [37] irlba_2.3.5.1           beachmat_2.24.0         progressr_0.17.0       \n [40] spatstat.sparse_3.1-0   httr_1.4.7              polyclip_1.10-7        \n [43] abind_1.4-8             compiler_4.5.1          withr_3.0.2            \n [46] S7_0.2.0                BiocParallel_1.42.2     fastDummies_1.7.5      \n [49] maps_3.4.3              MASS_7.3-65             DelayedArray_0.34.1    \n [52] tools_4.5.1             lmtest_0.9-40           otel_0.2.0             \n [55] httpuv_1.6.16           future.apply_1.20.0     goftest_1.2-3          \n [58] glue_1.8.0              nlme_3.1-168            promises_1.5.0         \n [61] grid_4.5.1              Rtsne_0.17              cluster_2.1.8.1        \n [64] reshape2_1.4.4          gtable_0.3.6            spatstat.data_3.1-9    \n [67] data.table_1.17.8       RApiSerialize_0.1.4     stringfish_0.17.0      \n [70] XVector_0.48.0          spatstat.geom_3.6-0     RcppAnnoy_0.0.22       \n [73] ggrepel_0.9.6           RANN_2.6.2              pillar_1.11.1          \n [76] stringr_1.5.2           pals_1.10               spam_2.11-1            \n [79] RcppHNSW_0.6.0          later_1.4.4             splines_4.5.1          \n [82] lattice_0.22-7          survival_3.8-3          deldir_2.0-4           \n [85] tidyselect_1.2.1        miniUI_0.1.2            pbapply_1.7-4          \n [88] knitr_1.50              gridExtra_2.3           scattermore_1.2        \n [91] xfun_0.54               stringi_1.8.7           UCSC.utils_1.4.0       \n [94] lazyeval_0.2.2          yaml_2.3.10             evaluate_1.0.5         \n [97] codetools_0.2-20        tibble_3.3.0            cli_3.6.5              \n[100] uwot_0.2.3              RcppParallel_5.1.11-1   xtable_1.8-4           \n[103] reticulate_1.44.0       dichromat_2.0-0.1       Rcpp_1.1.0             \n[106] globals_0.18.0          spatstat.random_3.4-2   mapproj_1.2.12         \n[109] png_0.1-8               spatstat.univar_3.1-4   parallel_4.5.1         \n[112] dotCall64_1.2           listenv_0.10.0          viridisLite_0.4.2      \n[115] scales_1.4.0            ggridges_0.5.7          crayon_1.5.3           \n[118] purrr_1.1.0             rlang_1.1.6             cowplot_1.2.0"
  },
  {
    "objectID": "code/00-ref.html#preamble",
    "href": "code/00-ref.html#preamble",
    "title": "ref",
    "section": "",
    "text": "library(qs)\nlibrary(Seurat)\nlibrary(scuttle)\nlibrary(SingleCellExperiment)\nsource(\"code/_utils.R\")"
  },
  {
    "objectID": "code/00-ref.html#loading",
    "href": "code/00-ref.html#loading",
    "title": "ref",
    "section": "",
    "text": "qs &lt;- list.files(\"data/ref\", \"qs$\", full.names=TRUE)\nnames(qs) &lt;- gsub(\"\\\\.qs\", \"\", basename(qs))\nse &lt;- lapply(qs, \\(.) {\n    so &lt;- qread(.)\n    se &lt;- as.SingleCellExperiment(so)\n    logcounts(se) &lt;- NULL\n    reducedDims(se) &lt;- list()\n    gs &lt;- VariableFeatures(so)\n    gs &lt;- rownames(se) %in% gs\n    rowData(se)$hvg &lt;- gs\n    se\n}); sapply(se, ncol)\n\n   mye    nkt    tum \n 48047 174677 151264"
  },
  {
    "objectID": "code/00-ref.html#labeling",
    "href": "code/00-ref.html#labeling",
    "title": "ref",
    "section": "",
    "text": "old &lt;- c(\"0\",\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"11\")\nnew &lt;- c(\n    \"Classical_monocytes\", \"Class. monocytes_HLA\", \n    \"Non-class. monocytes\", \"Class. monocytes_SELL\", \n    \"Class. monocytes_ribo\", \"DC2\", \"Class. monocytes_IFNresp\", \n    \"pDC_1\", \"Progenitor cells\", \"Platelets\", \"pDC_2\", \"DC1\")\nnev &lt;- list(\n    mono.c=c(\"Classical_monocytes\",\n        \"Class. monocytes_SELL\", \"Class. monocytes_HLA\",\n        \"Class. monocytes_ribo\", \"Class. monocytes_IFNresp\"),\n    mono.nc=\"Non-class. monocytes\",\n    pDC=c(\"pDC_2\", \"pDC_1\"),\n    DC=c(\"DC1\", \"DC2\"))\nnev &lt;- setNames(rep.int(names(nev), sapply(nev, length)), unlist(nev))\nlab &lt;- new[match(se$mye$ident, old)]\nlab &lt;- nev[match(lab, names(nev))]\ntable(se$mye$lab &lt;- lab, exclude=NULL)\n\n\n     DC  mono.c mono.nc     pDC    &lt;NA&gt; \n   3141   32819    8632    2230    1225 \n\n\n\nold &lt;- c(\"0\",\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"11\",\"12\",\"13\",\"14\",\"15\",\"17\",\"18\")\nnew &lt;- c(\n    \"CD16pos NK\",\"CD4 TCM TFH\",\"TEMRA\",\"CD4 TN\",\"CD8 TPEX\",\"CD4 TREG\",\n    \"CD4 TCM TH2\",\"NK-like T\",\"NK/ILC\",\"CD8 TEX\",\"CD4 TCM\",\"CD8 TEM\",\n    \"CD16neg NK\",\"CD8 TN\",\"MAIT\",\"Cycling T\",\"IFN responding\")\nnev &lt;- list(\n    \"NK/ILC\"=c(\"CD16neg NK\", \"CD16pos NK\", \"NK ILC3\"),\n    Tcm=c(\"CD4 TCM_TH2\", \"CD4 TCM\"),\n    Tex=c(\"CD8 TPEX\", \"CD8 TEX\"),\n    Tc=c(\"CD8 TEM\", \"TEMRA\"),\n    Tfh=\"CD4 TCM TFH\",\n    Treg=\"CD4 TREG\",\n    Tp=\"Cycling T\",\n    Thn=\"CD4 TN\",\n    Tcn=\"CD8 TN\")\nnev &lt;- setNames(rep.int(names(nev), sapply(nev, length)), unlist(nev))\nlab &lt;- new[match(se$nkt$ident, old)]\nlab &lt;- nev[match(lab, names(nev))]\ntable(se$nkt$lab &lt;- lab, exclude=NULL)\n\n\nNK/ILC     Tc    Tcm    Tcn    Tex    Tfh    Thn     Tp   Treg   &lt;NA&gt; \n 31217  22652   5570   4312  24062  25102  21647   2900  12270  24945"
  },
  {
    "objectID": "code/00-ref.html#pooling",
    "href": "code/00-ref.html#pooling",
    "title": "ref",
    "section": "",
    "text": "gs &lt;- Reduce(intersect, lapply(se, rownames))\nmx &lt;- do.call(cbind, lapply(se, \\(.) assay(.)[gs, ]))\ndim(mx &lt;- normalizeCounts(mx, log=FALSE))\n\n[1]  36190 373988"
  },
  {
    "objectID": "code/00-ref.html#profiles",
    "href": "code/00-ref.html#profiles",
    "title": "ref",
    "section": "",
    "text": "id &lt;- rep.int(names(se), sapply(se, ncol))\npb &lt;- summarizeAssayByGroup(mx, id, statistics=\"mean\")\nhead(pb &lt;- assay(pb))\n\n                     mye          nkt          tum\nMIR1302-2HG 0.000000e+00 5.128928e-06 6.104829e-05\nFAM138A     0.000000e+00 0.000000e+00 0.000000e+00\nOR4F5       0.000000e+00 0.000000e+00 0.000000e+00\nAL627309.1  2.167347e-03 8.358290e-04 1.458888e-03\nAL627309.3  2.226803e-05 2.605354e-05 4.804775e-05\nAL627309.2  5.940144e-05 0.000000e+00 0.000000e+00\n\n\n\n\n\n\nqb &lt;- lapply(se, \\(.) {\n    if (is.null(id &lt;- .$lab)) return()\n    cs &lt;- colnames(.)[!(ex &lt;- is.na(id))]\n    summarizeAssayByGroup(mx[, cs], id[!ex], statistics=\"mean\")\n})\nqb &lt;- qb[!sapply(qb, is.null)]\nqb &lt;- lapply(qb, assay)\nsapply(qb, colnames)\n\n$mye\n[1] \"DC\"      \"mono.c\"  \"mono.nc\" \"pDC\"    \n\n$nkt\n[1] \"NK/ILC\" \"Tc\"     \"Tcm\"    \"Tcn\"    \"Tex\"    \"Tfh\"    \"Thn\"    \"Tp\"    \n[9] \"Treg\""
  },
  {
    "objectID": "code/00-ref.html#appendix",
    "href": "code/00-ref.html#appendix",
    "title": "ref",
    "section": "",
    "text": "saveRDS(pb, \"outs/pbs.rds\")\nsaveRDS(qb, \"outs/qbs.rds\")\n\n\n\n\n\n\n\nsession\n\n\n\n\n\n\nsessionInfo()\n\nR version 4.5.1 (2025-06-13)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS Sequoia 15.6.1\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Europe/Madrid\ntzcode source: internal\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] patchwork_1.3.2             ggplot2_4.0.0              \n [3] tidyr_1.3.1                 dplyr_1.1.4                \n [5] scuttle_1.18.0              SingleCellExperiment_1.30.1\n [7] SummarizedExperiment_1.38.1 Biobase_2.68.0             \n [9] GenomicRanges_1.60.0        GenomeInfoDb_1.44.3        \n[11] IRanges_2.42.0              S4Vectors_0.46.0           \n[13] BiocGenerics_0.54.1         generics_0.1.4             \n[15] MatrixGenerics_1.20.0       matrixStats_1.5.0          \n[17] Seurat_5.3.1                SeuratObject_5.2.0         \n[19] sp_2.2-0                    qs_0.27.3                  \n\nloaded via a namespace (and not attached):\n  [1] RColorBrewer_1.1-3      rstudioapi_0.17.1       jsonlite_2.0.0         \n  [4] magrittr_2.0.4          spatstat.utils_3.2-0    farver_2.1.2           \n  [7] rmarkdown_2.30          vctrs_0.6.5             ROCR_1.0-11            \n [10] spatstat.explore_3.5-3  S4Arrays_1.8.1          htmltools_0.5.8.1      \n [13] SparseArray_1.8.1       sctransform_0.4.2       parallelly_1.45.1      \n [16] KernSmooth_2.23-26      htmlwidgets_1.6.4       ica_1.0-3              \n [19] plyr_1.8.9              plotly_4.11.0           zoo_1.8-14             \n [22] igraph_2.2.1            mime_0.13               lifecycle_1.0.4        \n [25] pkgconfig_2.0.3         Matrix_1.7-4            R6_2.6.1               \n [28] fastmap_1.2.0           GenomeInfoDbData_1.2.14 fitdistrplus_1.2-4     \n [31] future_1.67.0           shiny_1.11.1            digest_0.6.37          \n [34] colorspace_2.1-2        tensor_1.5.1            RSpectra_0.16-2        \n [37] irlba_2.3.5.1           beachmat_2.24.0         progressr_0.17.0       \n [40] spatstat.sparse_3.1-0   httr_1.4.7              polyclip_1.10-7        \n [43] abind_1.4-8             compiler_4.5.1          withr_3.0.2            \n [46] S7_0.2.0                BiocParallel_1.42.2     fastDummies_1.7.5      \n [49] maps_3.4.3              MASS_7.3-65             DelayedArray_0.34.1    \n [52] tools_4.5.1             lmtest_0.9-40           otel_0.2.0             \n [55] httpuv_1.6.16           future.apply_1.20.0     goftest_1.2-3          \n [58] glue_1.8.0              nlme_3.1-168            promises_1.5.0         \n [61] grid_4.5.1              Rtsne_0.17              cluster_2.1.8.1        \n [64] reshape2_1.4.4          gtable_0.3.6            spatstat.data_3.1-9    \n [67] data.table_1.17.8       RApiSerialize_0.1.4     stringfish_0.17.0      \n [70] XVector_0.48.0          spatstat.geom_3.6-0     RcppAnnoy_0.0.22       \n [73] ggrepel_0.9.6           RANN_2.6.2              pillar_1.11.1          \n [76] stringr_1.5.2           pals_1.10               spam_2.11-1            \n [79] RcppHNSW_0.6.0          later_1.4.4             splines_4.5.1          \n [82] lattice_0.22-7          survival_3.8-3          deldir_2.0-4           \n [85] tidyselect_1.2.1        miniUI_0.1.2            pbapply_1.7-4          \n [88] knitr_1.50              gridExtra_2.3           scattermore_1.2        \n [91] xfun_0.54               stringi_1.8.7           UCSC.utils_1.4.0       \n [94] lazyeval_0.2.2          yaml_2.3.10             evaluate_1.0.5         \n [97] codetools_0.2-20        tibble_3.3.0            cli_3.6.5              \n[100] uwot_0.2.3              RcppParallel_5.1.11-1   xtable_1.8-4           \n[103] reticulate_1.44.0       dichromat_2.0-0.1       Rcpp_1.1.0             \n[106] globals_0.18.0          spatstat.random_3.4-2   mapproj_1.2.12         \n[109] png_0.1-8               spatstat.univar_3.1-4   parallel_4.5.1         \n[112] dotCall64_1.2           listenv_0.10.0          viridisLite_0.4.2      \n[115] scales_1.4.0            ggridges_0.5.7          crayon_1.5.3           \n[118] purrr_1.1.0             rlang_1.1.6             cowplot_1.2.0"
  },
  {
    "objectID": "code/00-raw.html",
    "href": "code/00-raw.html",
    "title": "raw",
    "section": "",
    "text": "library(arrow)\nlibrary(dplyr)\nlibrary(Matrix)\nlibrary(SparseArray)\nlibrary(SingleCellExperiment)\nsource(\"code/_utils.R\")\n\n\n# add local & global coordinates in mm\n.mm &lt;- \\(df, px=\".*_(local|global)_(px)\") {\n    px &lt;- grep(px, names(df))\n    mm &lt;- sapply(df[px], .px2mm)\n    nm &lt;- gsub(\"px$\", \"mm\", colnames(mm))\n    colnames(mm) &lt;- nm; cbind(df, mm)\n}\n\n\n\n\n\n# construct SCE from transcript counts & cell metadata\ncd &lt;- .mm(read.csv(\"data/raw/metadata.csv\"))\nmx &lt;- readSparseCSV(\"data/raw/counts.csv\", transpose=TRUE)\nmy &lt;- `colnames&lt;-`(as(mx[-1, ], \"dgCMatrix\"), cd$cell)\n(sce &lt;- SingleCellExperiment(list(counts=my), colData=cd))\n\nclass: SingleCellExperiment \ndim: 6720 441984 \nmetadata(0):\nassays(1): counts\nrownames(6720): A1BG A2M ... SystemControl98 SystemControl99\nrowData names(0):\ncolnames(441984): c_1_1_1 c_1_1_2 ... c_1_364_1966 c_1_364_1967\ncolData names(64): cell nCount_RNA ... CenterX_global_mm\n  CenterY_global_mm\nreducedDimNames(0):\nmainExpName: NULL\naltExpNames(0):\n\n\n\n\n\n\n\n\n# move negative probe & blank code data to 'altExps'\nnames(gs) &lt;- gs &lt;- c(\"Negative\", \"SystemControl\")\ngs &lt;- lapply(gs, grep, rownames(sce))\naltExps(sce) &lt;- lapply(gs, \\(.) sce[., ])\nsce &lt;- sce[-unlist(gs), ]\nsapply(gs, length)\n\n     Negative SystemControl \n           21           324 \n\n\n\n\n\n\n# add core-level metadata\nmd &lt;- read.csv(\"data/raw/mapping.csv\")\nmd &lt;- md[md$biopsy_site != \"TO\", ]\nsub &lt;- sce[, sce$fov %in% md$fov]\ni &lt;- match(sub$fov, md$fov)\nj &lt;- setdiff(names(md), names(colData(sub)))\ncolData(sub) &lt;- cbind(colData(sub), md[i, j])\ncat(\"genes: \", nrow(sub), \"; \", sep=\"\", \n    \"cells: \", ncol(sub), \"/\", ncol(sce))\n\ngenes: 6375; cells: 105174/441984\n\n\n\n\n\n\n# prepare polygons\npol &lt;- read.csv(\"data/raw/polygons.csv\")\npol &lt;- filter(pol, cell %in% colnames(sub))\nat &lt;- arrow_table(.mm(pol))\n\n\n\n\n\n# streamline identifiers\nfoo &lt;- c(n=\"MCLN\", m=\"MCLMZ\", d=\"MCLD\")\nns &lt;- rowSums(tbl &lt;- table(sub$core, sub$roi) &gt; 1)\nns &lt;- lapply(ns, \\(.) if (. == 1) 0 else seq(.))\nsub$roi &lt;- factor(unlist(ns)[match(sub$roi, colnames(tbl))])\nsub$gid &lt;- factor(sub$pathology, foo, names(foo))\nsub$pid &lt;- factor(sprintf(\"%02d\", as.integer(factor(sub$core))))\nsub$typ &lt;- factor(ifelse((. &lt;- sub$biopsy_site) == \"EYE\", \"EY\", .))\ntable(sub$sid &lt;- paste0(sub$pid, sub$roi, sub$typ, sub$gid), sub$typ)\n\n        \n           EY   LN   NP   SO\n  011LNd    0 4969    0    0\n  012LNd    0 5695    0    0\n  020LNm    0 2449    0    0\n  031LNd    0 7357    0    0\n  032LNd    0 4836    0    0\n  041SOd    0    0    0 3694\n  042SOd    0    0    0 4391\n  051LNn    0 7613    0    0\n  052LNn    0 6241    0    0\n  061LNd    0 4338    0    0\n  062LNd    0 3974    0    0\n  071NPd    0    0 3743    0\n  072NPd    0    0 6578    0\n  080LNn    0 5480    0    0\n  091EYn 2129    0    0    0\n  092EYn 1325    0    0    0\n  100LNd    0 3527    0    0\n  111LNn    0 4587    0    0\n  112LNn    0 4045    0    0\n  121LNm    0 9003    0    0\n  122LNm    0 9200    0    0\n\n\n\n\n\n\n\n\n\nsaveRDS(sub, \"outs/raw.rds\")\n\n\n\n\n\n\n\nsession\n\n\n\n\n\n\nsessionInfo()\n\nR version 4.5.1 (2025-06-13)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS Sequoia 15.6.1\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Europe/Madrid\ntzcode source: internal\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] patchwork_1.3.2             ggplot2_4.0.0              \n [3] tidyr_1.3.1                 SingleCellExperiment_1.30.1\n [5] SummarizedExperiment_1.38.1 Biobase_2.68.0             \n [7] GenomicRanges_1.60.0        GenomeInfoDb_1.44.3        \n [9] SparseArray_1.8.1           S4Arrays_1.8.1             \n[11] IRanges_2.42.0              abind_1.4-8                \n[13] S4Vectors_0.46.0            MatrixGenerics_1.20.0      \n[15] matrixStats_1.5.0           BiocGenerics_0.54.1        \n[17] generics_0.1.4              Matrix_1.7-4               \n[19] dplyr_1.1.4                 arrow_22.0.0               \n\nloaded via a namespace (and not attached):\n [1] gtable_0.3.6            xfun_0.54               htmlwidgets_1.6.4      \n [4] lattice_0.22-7          vctrs_0.6.5             tools_4.5.1            \n [7] tibble_3.3.0            pkgconfig_2.0.3         RColorBrewer_1.1-3     \n[10] S7_0.2.0                pals_1.10               assertthat_0.2.1       \n[13] lifecycle_1.0.4         GenomeInfoDbData_1.2.14 compiler_4.5.1         \n[16] farver_2.1.2            mapproj_1.2.12          htmltools_0.5.8.1      \n[19] maps_3.4.3              yaml_2.3.10             pillar_1.11.1          \n[22] crayon_1.5.3            DelayedArray_0.34.1     tidyselect_1.2.1       \n[25] digest_0.6.37           purrr_1.1.0             fastmap_1.2.0          \n[28] grid_4.5.1              colorspace_2.1-2        cli_3.6.5              \n[31] magrittr_2.0.4          dichromat_2.0-0.1       withr_3.0.2            \n[34] UCSC.utils_1.4.0        scales_1.4.0            bit64_4.6.0-1          \n[37] rmarkdown_2.30          XVector_0.48.0          httr_1.4.7             \n[40] bit_4.6.0               evaluate_1.0.5          knitr_1.50             \n[43] rlang_1.1.6             glue_1.8.0              rstudioapi_0.17.1      \n[46] jsonlite_2.0.0          R6_2.6.1"
  },
  {
    "objectID": "code/00-raw.html#preamble",
    "href": "code/00-raw.html#preamble",
    "title": "raw",
    "section": "",
    "text": "library(arrow)\nlibrary(dplyr)\nlibrary(Matrix)\nlibrary(SparseArray)\nlibrary(SingleCellExperiment)\nsource(\"code/_utils.R\")\n\n\n# add local & global coordinates in mm\n.mm &lt;- \\(df, px=\".*_(local|global)_(px)\") {\n    px &lt;- grep(px, names(df))\n    mm &lt;- sapply(df[px], .px2mm)\n    nm &lt;- gsub(\"px$\", \"mm\", colnames(mm))\n    colnames(mm) &lt;- nm; cbind(df, mm)\n}"
  },
  {
    "objectID": "code/00-raw.html#loading",
    "href": "code/00-raw.html#loading",
    "title": "raw",
    "section": "",
    "text": "# construct SCE from transcript counts & cell metadata\ncd &lt;- .mm(read.csv(\"data/raw/metadata.csv\"))\nmx &lt;- readSparseCSV(\"data/raw/counts.csv\", transpose=TRUE)\nmy &lt;- `colnames&lt;-`(as(mx[-1, ], \"dgCMatrix\"), cd$cell)\n(sce &lt;- SingleCellExperiment(list(counts=my), colData=cd))\n\nclass: SingleCellExperiment \ndim: 6720 441984 \nmetadata(0):\nassays(1): counts\nrownames(6720): A1BG A2M ... SystemControl98 SystemControl99\nrowData names(0):\ncolnames(441984): c_1_1_1 c_1_1_2 ... c_1_364_1966 c_1_364_1967\ncolData names(64): cell nCount_RNA ... CenterX_global_mm\n  CenterY_global_mm\nreducedDimNames(0):\nmainExpName: NULL\naltExpNames(0):"
  },
  {
    "objectID": "code/00-raw.html#wrangling",
    "href": "code/00-raw.html#wrangling",
    "title": "raw",
    "section": "",
    "text": "# move negative probe & blank code data to 'altExps'\nnames(gs) &lt;- gs &lt;- c(\"Negative\", \"SystemControl\")\ngs &lt;- lapply(gs, grep, rownames(sce))\naltExps(sce) &lt;- lapply(gs, \\(.) sce[., ])\nsce &lt;- sce[-unlist(gs), ]\nsapply(gs, length)\n\n     Negative SystemControl \n           21           324 \n\n\n\n\n\n\n# add core-level metadata\nmd &lt;- read.csv(\"data/raw/mapping.csv\")\nmd &lt;- md[md$biopsy_site != \"TO\", ]\nsub &lt;- sce[, sce$fov %in% md$fov]\ni &lt;- match(sub$fov, md$fov)\nj &lt;- setdiff(names(md), names(colData(sub)))\ncolData(sub) &lt;- cbind(colData(sub), md[i, j])\ncat(\"genes: \", nrow(sub), \"; \", sep=\"\", \n    \"cells: \", ncol(sub), \"/\", ncol(sce))\n\ngenes: 6375; cells: 105174/441984\n\n\n\n\n\n\n# prepare polygons\npol &lt;- read.csv(\"data/raw/polygons.csv\")\npol &lt;- filter(pol, cell %in% colnames(sub))\nat &lt;- arrow_table(.mm(pol))\n\n\n\n\n\n# streamline identifiers\nfoo &lt;- c(n=\"MCLN\", m=\"MCLMZ\", d=\"MCLD\")\nns &lt;- rowSums(tbl &lt;- table(sub$core, sub$roi) &gt; 1)\nns &lt;- lapply(ns, \\(.) if (. == 1) 0 else seq(.))\nsub$roi &lt;- factor(unlist(ns)[match(sub$roi, colnames(tbl))])\nsub$gid &lt;- factor(sub$pathology, foo, names(foo))\nsub$pid &lt;- factor(sprintf(\"%02d\", as.integer(factor(sub$core))))\nsub$typ &lt;- factor(ifelse((. &lt;- sub$biopsy_site) == \"EYE\", \"EY\", .))\ntable(sub$sid &lt;- paste0(sub$pid, sub$roi, sub$typ, sub$gid), sub$typ)\n\n        \n           EY   LN   NP   SO\n  011LNd    0 4969    0    0\n  012LNd    0 5695    0    0\n  020LNm    0 2449    0    0\n  031LNd    0 7357    0    0\n  032LNd    0 4836    0    0\n  041SOd    0    0    0 3694\n  042SOd    0    0    0 4391\n  051LNn    0 7613    0    0\n  052LNn    0 6241    0    0\n  061LNd    0 4338    0    0\n  062LNd    0 3974    0    0\n  071NPd    0    0 3743    0\n  072NPd    0    0 6578    0\n  080LNn    0 5480    0    0\n  091EYn 2129    0    0    0\n  092EYn 1325    0    0    0\n  100LNd    0 3527    0    0\n  111LNn    0 4587    0    0\n  112LNn    0 4045    0    0\n  121LNm    0 9003    0    0\n  122LNm    0 9200    0    0"
  },
  {
    "objectID": "code/00-raw.html#appendix",
    "href": "code/00-raw.html#appendix",
    "title": "raw",
    "section": "",
    "text": "saveRDS(sub, \"outs/raw.rds\")\n\n\n\n\n\n\n\nsession\n\n\n\n\n\n\nsessionInfo()\n\nR version 4.5.1 (2025-06-13)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS Sequoia 15.6.1\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Europe/Madrid\ntzcode source: internal\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] patchwork_1.3.2             ggplot2_4.0.0              \n [3] tidyr_1.3.1                 SingleCellExperiment_1.30.1\n [5] SummarizedExperiment_1.38.1 Biobase_2.68.0             \n [7] GenomicRanges_1.60.0        GenomeInfoDb_1.44.3        \n [9] SparseArray_1.8.1           S4Arrays_1.8.1             \n[11] IRanges_2.42.0              abind_1.4-8                \n[13] S4Vectors_0.46.0            MatrixGenerics_1.20.0      \n[15] matrixStats_1.5.0           BiocGenerics_0.54.1        \n[17] generics_0.1.4              Matrix_1.7-4               \n[19] dplyr_1.1.4                 arrow_22.0.0               \n\nloaded via a namespace (and not attached):\n [1] gtable_0.3.6            xfun_0.54               htmlwidgets_1.6.4      \n [4] lattice_0.22-7          vctrs_0.6.5             tools_4.5.1            \n [7] tibble_3.3.0            pkgconfig_2.0.3         RColorBrewer_1.1-3     \n[10] S7_0.2.0                pals_1.10               assertthat_0.2.1       \n[13] lifecycle_1.0.4         GenomeInfoDbData_1.2.14 compiler_4.5.1         \n[16] farver_2.1.2            mapproj_1.2.12          htmltools_0.5.8.1      \n[19] maps_3.4.3              yaml_2.3.10             pillar_1.11.1          \n[22] crayon_1.5.3            DelayedArray_0.34.1     tidyselect_1.2.1       \n[25] digest_0.6.37           purrr_1.1.0             fastmap_1.2.0          \n[28] grid_4.5.1              colorspace_2.1-2        cli_3.6.5              \n[31] magrittr_2.0.4          dichromat_2.0-0.1       withr_3.0.2            \n[34] UCSC.utils_1.4.0        scales_1.4.0            bit64_4.6.0-1          \n[37] rmarkdown_2.30          XVector_0.48.0          httr_1.4.7             \n[40] bit_4.6.0               evaluate_1.0.5          knitr_1.50             \n[43] rlang_1.1.6             glue_1.8.0              rstudioapi_0.17.1      \n[46] jsonlite_2.0.0          R6_2.6.1"
  },
  {
    "objectID": "code/01-fil.html",
    "href": "code/01-fil.html",
    "title": "fil",
    "section": "",
    "text": "library(zoo)\nlibrary(tidyr)\nlibrary(dplyr)\nlibrary(scuttle)\nlibrary(ggplot2)\nlibrary(patchwork)\nlibrary(SingleCellExperiment)\nsource(\"code/_utils.R\")\n\n\n\n\n\n# drop problematic core\nsce &lt;- readRDS(\"outs/raw.rds\")\n(sce &lt;- sce[, sce$sid != \"032LNd\"])\n\nclass: SingleCellExperiment \ndim: 6375 100338 \nmetadata(0):\nassays(1): counts\nrownames(6375): A1BG A2M ... ZYX ZZZ3\nrowData names(0):\ncolnames(100338): c_1_287_1 c_1_287_2 ... c_1_364_1966 c_1_364_1967\ncolData names(76): cell nCount_RNA ... typ sid\nreducedDimNames(0):\nmainExpName: NULL\naltExpNames(2): Negative SystemControl\n\n\n\n\n\n\n\n\n# exclude cells less than 'd' from any FOV border;\n# 'd' = third radius of an average (circular) cell\nds &lt;- .d2b(colData(sce))\nmm2 &lt;- sce$Area.um2*1e-6\nth_d &lt;- mean(sqrt(mm2/pi))/3\nex_d &lt;- rowAnys(ds &lt; th_d)\n\n\n\n\n\n# exclude low-quality cells based on total counts & detected features\n.f &lt;- \\(x, n=2.5, i=sce$sid) isOutlier(x, n, \"lower\", TRUE, batch=i)\n.g &lt;- \\(x) attr(x, \"threshold\")[1, ]\n\nth_n &lt;- .g(ex_n &lt;- .f(sce$nCount_RNA))\nth_m &lt;- .g(ex_m &lt;- .f(sce$nFeature_RNA))\nth_a &lt;- .g(ex_a &lt;- .f(sce$nCount_RNA/sce$Area.um2))\n\n\n# stash thresholds\nths &lt;- data.frame(d=th_d*1e3, n=th_n, m=th_m, a=th_a)\nths &lt;- data.frame(row.names=NULL, sid=rownames(ths), ths)\nformat(metadata(sce)$ths &lt;- ths, digits=2)\n\n      sid   d   n   m     a\n1  011LNd 1.7 207 174  3.80\n2  012LNd 1.7 330 272  7.58\n3  020LNm 1.7  46  39  1.06\n4  031LNd 1.7  90  93  2.12\n5  041SOd 1.7  95  80  1.96\n6  042SOd 1.7 275 218  5.27\n7  051LNn 1.7 129 110  2.85\n8  052LNn 1.7  98  87  1.91\n9  061LNd 1.7 239 203  6.45\n10 062LNd 1.7 321 277  6.81\n11 071NPd 1.7  32  30  0.71\n12 072NPd 1.7  72  60  1.98\n13 080LNn 1.7 255 215  5.98\n14 091EYn 1.7 299 262  9.98\n15 092EYn 1.7 140 131  3.68\n16 100LNd 1.7 201 184  4.37\n17 111LNn 1.7  76  68  0.97\n18 112LNn 1.7  69  60  1.08\n19 121LNm 1.7  57  52  1.87\n20 122LNm 1.7  69  58  1.94\n\n\n\n\n\n\n\n# filtering\nex &lt;- cbind(ex_d, ex_n, ex_m, ex_a)\nsub &lt;- sce[, !rowAnys(ex)]\n# percent excluded by each\nround(100*colMeans(ex), 2)\n\nex_d ex_n ex_m ex_a \n0.89 3.95 4.51 6.78 \n\n# percent excluded overall\nround(100*ncol(sub)/ncol(sce), 2)\n\n[1] 91.52\n\n# number of cells raw/fil\nc(ncol(sce), ncol(sub))\n\n[1] 100338  91833\n\n# cell area statistics\nsummary(sub$Area.um2)\n\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n  10.26   54.93   76.42   85.12  106.38  488.97 \n\n\n\n\n\n\n\nCode\n# wrangling\ncd &lt;- data.frame(colData(sce))\ncd$cpa &lt;- with(cd, nCount_RNA/Area.um2)\ndf &lt;- cbind(cd, d &lt;- .d2b(cd)) |&gt;\n    pivot_longer(all_of(colnames(d))) |&gt;\n    mutate(value=value*1e3) |&gt;\n    mutate(name=factor(name, \n        c(\"t\", \"r\", \"b\", \"l\"),\n        c(\"top\", \"right\", \"bottom\", \"left\")))\nfd &lt;- df |&gt;\n    group_by(name, value) |&gt;\n    summarise_at(\"cpa\", mean) |&gt;\n    arrange(value) |&gt; group_by(name) |&gt; mutate(\n        mu_x=rollmean(value, 20, mean, align=\"left\", fill=0),\n        mu_y=rollmean(cpa, 20, mean, align=\"left\", fill=0)) \nmu &lt;- data.frame(name=unique(fd$name), y=mean(cd$cpa))\nmd &lt;- metadata(sub)$ths |&gt;\n    select(where(is.numeric)) |&gt;\n    summarise(across(everything(), mean))\n\n# plotting\ndy &lt;- ceiling(max(fd$mu_y)/0.1)*0.1\nggplot(fd, aes(mu_x, mu_y)) +\n    facet_grid(~name) + geom_line(col=\"navy\", linewidth=0.4) +\n    geom_vline(xintercept=md$d, col=\"red\", linewidth=0.4, lty=2) +\n    geom_hline(yintercept=md$a, col=\"red\", linewidth=0.4, lty=2) +\n    geom_hline(data=mu, aes(yintercept=y), col=\"blue\", linewidth=0.4) +\n    scale_x_continuous(\"FOV border distance (um)\", expand=expansion(0.04)) +\n    scale_y_continuous(\"RNA counts per um\", n.breaks=3, expand=expansion(0.06)) +\n    theme(plot.title=element_text(hjust=0.5)) + .thm_fig(\"bw\") +\n    coord_cartesian(xlim=c(0, 60), ylim=c(0, dy))\n\n\n\n\n\n\n\n\n\n\n\nCode\nex &lt;- !colnames(sce) %in% colnames(sub)\ndf &lt;- as.data.frame(table(sid=sce$sid, ex))\np0 &lt;- ggplot(df, aes(Freq, sid, fill=ex))\np1 &lt;- p0 + \n    geom_col(position=\"fill\", key_glyph=\"point\") +\n    scale_x_continuous(\"% cells\", n.breaks=6) +\n    .thm_fig_d(\"bw\", \"f\") + theme(\n        panel.grid=element_blank())\np2 &lt;- p0 + \n    geom_col(position=\"identity\", key_glyph=\"point\") + \n    scale_x_continuous(\"# cells\", limits=c(0, 1e4), n.breaks=6) +\n    geom_text(\n        aes(Inf, label=format(Freq, big.mark=\",\")),\n        filter(df, ex == FALSE), hjust=1.1, size=2) +\n    .thm_fig_d(\"bw\", \"f\") + theme(\n        axis.text.y=element_blank(),\n        axis.ticks.y=element_blank(),\n        panel.grid.major.y=element_blank())\n(p1+p2) + \n    plot_layout(nrow=1, guides=\"collect\") &\n    labs(y=NULL) & scale_fill_manual(\"excluded\",\n        values=c(\"slategray1\", \"slategray\")) &\n    coord_cartesian(expand=FALSE) & \n    theme(aspect.ratio=1) \n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nsaveRDS(sub, \"outs/fil.rds\")\n\n\n\n\n\n\n\nsession\n\n\n\n\n\n\nsessionInfo()\n\nR version 4.5.1 (2025-06-13)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS Sequoia 15.6.1\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Europe/Madrid\ntzcode source: internal\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] patchwork_1.3.2             ggplot2_4.0.0              \n [3] scuttle_1.18.0              SingleCellExperiment_1.30.1\n [5] SummarizedExperiment_1.38.1 Biobase_2.68.0             \n [7] GenomicRanges_1.60.0        GenomeInfoDb_1.44.3        \n [9] IRanges_2.42.0              S4Vectors_0.46.0           \n[11] BiocGenerics_0.54.1         generics_0.1.4             \n[13] MatrixGenerics_1.20.0       matrixStats_1.5.0          \n[15] dplyr_1.1.4                 tidyr_1.3.1                \n[17] zoo_1.8-14                 \n\nloaded via a namespace (and not attached):\n [1] gtable_0.3.6            xfun_0.54               htmlwidgets_1.6.4      \n [4] lattice_0.22-7          vctrs_0.6.5             tools_4.5.1            \n [7] parallel_4.5.1          tibble_3.3.0            pkgconfig_2.0.3        \n[10] Matrix_1.7-4            RColorBrewer_1.1-3      S7_0.2.0               \n[13] pals_1.10               lifecycle_1.0.4         GenomeInfoDbData_1.2.14\n[16] compiler_4.5.1          farver_2.1.2            mapproj_1.2.12         \n[19] codetools_0.2-20        htmltools_0.5.8.1       maps_3.4.3             \n[22] yaml_2.3.10             pillar_1.11.1           crayon_1.5.3           \n[25] BiocParallel_1.42.2     DelayedArray_0.34.1     abind_1.4-8            \n[28] tidyselect_1.2.1        digest_0.6.37           purrr_1.1.0            \n[31] labeling_0.4.3          fastmap_1.2.0           grid_4.5.1             \n[34] colorspace_2.1-2        cli_3.6.5               SparseArray_1.8.1      \n[37] magrittr_2.0.4          S4Arrays_1.8.1          dichromat_2.0-0.1      \n[40] withr_3.0.2             UCSC.utils_1.4.0        scales_1.4.0           \n[43] rmarkdown_2.30          XVector_0.48.0          httr_1.4.7             \n[46] beachmat_2.24.0         evaluate_1.0.5          knitr_1.50             \n[49] rlang_1.1.6             Rcpp_1.1.0              glue_1.8.0             \n[52] rstudioapi_0.17.1       jsonlite_2.0.0          R6_2.6.1"
  },
  {
    "objectID": "code/01-fil.html#preamble",
    "href": "code/01-fil.html#preamble",
    "title": "fil",
    "section": "",
    "text": "library(zoo)\nlibrary(tidyr)\nlibrary(dplyr)\nlibrary(scuttle)\nlibrary(ggplot2)\nlibrary(patchwork)\nlibrary(SingleCellExperiment)\nsource(\"code/_utils.R\")"
  },
  {
    "objectID": "code/01-fil.html#loading",
    "href": "code/01-fil.html#loading",
    "title": "fil",
    "section": "",
    "text": "# drop problematic core\nsce &lt;- readRDS(\"outs/raw.rds\")\n(sce &lt;- sce[, sce$sid != \"032LNd\"])\n\nclass: SingleCellExperiment \ndim: 6375 100338 \nmetadata(0):\nassays(1): counts\nrownames(6375): A1BG A2M ... ZYX ZZZ3\nrowData names(0):\ncolnames(100338): c_1_287_1 c_1_287_2 ... c_1_364_1966 c_1_364_1967\ncolData names(76): cell nCount_RNA ... typ sid\nreducedDimNames(0):\nmainExpName: NULL\naltExpNames(2): Negative SystemControl"
  },
  {
    "objectID": "code/01-fil.html#quality-control",
    "href": "code/01-fil.html#quality-control",
    "title": "fil",
    "section": "",
    "text": "# exclude cells less than 'd' from any FOV border;\n# 'd' = third radius of an average (circular) cell\nds &lt;- .d2b(colData(sce))\nmm2 &lt;- sce$Area.um2*1e-6\nth_d &lt;- mean(sqrt(mm2/pi))/3\nex_d &lt;- rowAnys(ds &lt; th_d)\n\n\n\n\n\n# exclude low-quality cells based on total counts & detected features\n.f &lt;- \\(x, n=2.5, i=sce$sid) isOutlier(x, n, \"lower\", TRUE, batch=i)\n.g &lt;- \\(x) attr(x, \"threshold\")[1, ]\n\nth_n &lt;- .g(ex_n &lt;- .f(sce$nCount_RNA))\nth_m &lt;- .g(ex_m &lt;- .f(sce$nFeature_RNA))\nth_a &lt;- .g(ex_a &lt;- .f(sce$nCount_RNA/sce$Area.um2))\n\n\n# stash thresholds\nths &lt;- data.frame(d=th_d*1e3, n=th_n, m=th_m, a=th_a)\nths &lt;- data.frame(row.names=NULL, sid=rownames(ths), ths)\nformat(metadata(sce)$ths &lt;- ths, digits=2)\n\n      sid   d   n   m     a\n1  011LNd 1.7 207 174  3.80\n2  012LNd 1.7 330 272  7.58\n3  020LNm 1.7  46  39  1.06\n4  031LNd 1.7  90  93  2.12\n5  041SOd 1.7  95  80  1.96\n6  042SOd 1.7 275 218  5.27\n7  051LNn 1.7 129 110  2.85\n8  052LNn 1.7  98  87  1.91\n9  061LNd 1.7 239 203  6.45\n10 062LNd 1.7 321 277  6.81\n11 071NPd 1.7  32  30  0.71\n12 072NPd 1.7  72  60  1.98\n13 080LNn 1.7 255 215  5.98\n14 091EYn 1.7 299 262  9.98\n15 092EYn 1.7 140 131  3.68\n16 100LNd 1.7 201 184  4.37\n17 111LNn 1.7  76  68  0.97\n18 112LNn 1.7  69  60  1.08\n19 121LNm 1.7  57  52  1.87\n20 122LNm 1.7  69  58  1.94"
  },
  {
    "objectID": "code/01-fil.html#filtering",
    "href": "code/01-fil.html#filtering",
    "title": "fil",
    "section": "",
    "text": "# filtering\nex &lt;- cbind(ex_d, ex_n, ex_m, ex_a)\nsub &lt;- sce[, !rowAnys(ex)]\n# percent excluded by each\nround(100*colMeans(ex), 2)\n\nex_d ex_n ex_m ex_a \n0.89 3.95 4.51 6.78 \n\n# percent excluded overall\nround(100*ncol(sub)/ncol(sce), 2)\n\n[1] 91.52\n\n# number of cells raw/fil\nc(ncol(sce), ncol(sub))\n\n[1] 100338  91833\n\n# cell area statistics\nsummary(sub$Area.um2)\n\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n  10.26   54.93   76.42   85.12  106.38  488.97"
  },
  {
    "objectID": "code/01-fil.html#visuals",
    "href": "code/01-fil.html#visuals",
    "title": "fil",
    "section": "",
    "text": "Code\n# wrangling\ncd &lt;- data.frame(colData(sce))\ncd$cpa &lt;- with(cd, nCount_RNA/Area.um2)\ndf &lt;- cbind(cd, d &lt;- .d2b(cd)) |&gt;\n    pivot_longer(all_of(colnames(d))) |&gt;\n    mutate(value=value*1e3) |&gt;\n    mutate(name=factor(name, \n        c(\"t\", \"r\", \"b\", \"l\"),\n        c(\"top\", \"right\", \"bottom\", \"left\")))\nfd &lt;- df |&gt;\n    group_by(name, value) |&gt;\n    summarise_at(\"cpa\", mean) |&gt;\n    arrange(value) |&gt; group_by(name) |&gt; mutate(\n        mu_x=rollmean(value, 20, mean, align=\"left\", fill=0),\n        mu_y=rollmean(cpa, 20, mean, align=\"left\", fill=0)) \nmu &lt;- data.frame(name=unique(fd$name), y=mean(cd$cpa))\nmd &lt;- metadata(sub)$ths |&gt;\n    select(where(is.numeric)) |&gt;\n    summarise(across(everything(), mean))\n\n# plotting\ndy &lt;- ceiling(max(fd$mu_y)/0.1)*0.1\nggplot(fd, aes(mu_x, mu_y)) +\n    facet_grid(~name) + geom_line(col=\"navy\", linewidth=0.4) +\n    geom_vline(xintercept=md$d, col=\"red\", linewidth=0.4, lty=2) +\n    geom_hline(yintercept=md$a, col=\"red\", linewidth=0.4, lty=2) +\n    geom_hline(data=mu, aes(yintercept=y), col=\"blue\", linewidth=0.4) +\n    scale_x_continuous(\"FOV border distance (um)\", expand=expansion(0.04)) +\n    scale_y_continuous(\"RNA counts per um\", n.breaks=3, expand=expansion(0.06)) +\n    theme(plot.title=element_text(hjust=0.5)) + .thm_fig(\"bw\") +\n    coord_cartesian(xlim=c(0, 60), ylim=c(0, dy))\n\n\n\n\n\n\n\n\n\n\n\nCode\nex &lt;- !colnames(sce) %in% colnames(sub)\ndf &lt;- as.data.frame(table(sid=sce$sid, ex))\np0 &lt;- ggplot(df, aes(Freq, sid, fill=ex))\np1 &lt;- p0 + \n    geom_col(position=\"fill\", key_glyph=\"point\") +\n    scale_x_continuous(\"% cells\", n.breaks=6) +\n    .thm_fig_d(\"bw\", \"f\") + theme(\n        panel.grid=element_blank())\np2 &lt;- p0 + \n    geom_col(position=\"identity\", key_glyph=\"point\") + \n    scale_x_continuous(\"# cells\", limits=c(0, 1e4), n.breaks=6) +\n    geom_text(\n        aes(Inf, label=format(Freq, big.mark=\",\")),\n        filter(df, ex == FALSE), hjust=1.1, size=2) +\n    .thm_fig_d(\"bw\", \"f\") + theme(\n        axis.text.y=element_blank(),\n        axis.ticks.y=element_blank(),\n        panel.grid.major.y=element_blank())\n(p1+p2) + \n    plot_layout(nrow=1, guides=\"collect\") &\n    labs(y=NULL) & scale_fill_manual(\"excluded\",\n        values=c(\"slategray1\", \"slategray\")) &\n    coord_cartesian(expand=FALSE) & \n    theme(aspect.ratio=1)"
  },
  {
    "objectID": "code/01-fil.html#appendix",
    "href": "code/01-fil.html#appendix",
    "title": "fil",
    "section": "",
    "text": "saveRDS(sub, \"outs/fil.rds\")\n\n\n\n\n\n\n\nsession\n\n\n\n\n\n\nsessionInfo()\n\nR version 4.5.1 (2025-06-13)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS Sequoia 15.6.1\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Europe/Madrid\ntzcode source: internal\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] patchwork_1.3.2             ggplot2_4.0.0              \n [3] scuttle_1.18.0              SingleCellExperiment_1.30.1\n [5] SummarizedExperiment_1.38.1 Biobase_2.68.0             \n [7] GenomicRanges_1.60.0        GenomeInfoDb_1.44.3        \n [9] IRanges_2.42.0              S4Vectors_0.46.0           \n[11] BiocGenerics_0.54.1         generics_0.1.4             \n[13] MatrixGenerics_1.20.0       matrixStats_1.5.0          \n[15] dplyr_1.1.4                 tidyr_1.3.1                \n[17] zoo_1.8-14                 \n\nloaded via a namespace (and not attached):\n [1] gtable_0.3.6            xfun_0.54               htmlwidgets_1.6.4      \n [4] lattice_0.22-7          vctrs_0.6.5             tools_4.5.1            \n [7] parallel_4.5.1          tibble_3.3.0            pkgconfig_2.0.3        \n[10] Matrix_1.7-4            RColorBrewer_1.1-3      S7_0.2.0               \n[13] pals_1.10               lifecycle_1.0.4         GenomeInfoDbData_1.2.14\n[16] compiler_4.5.1          farver_2.1.2            mapproj_1.2.12         \n[19] codetools_0.2-20        htmltools_0.5.8.1       maps_3.4.3             \n[22] yaml_2.3.10             pillar_1.11.1           crayon_1.5.3           \n[25] BiocParallel_1.42.2     DelayedArray_0.34.1     abind_1.4-8            \n[28] tidyselect_1.2.1        digest_0.6.37           purrr_1.1.0            \n[31] labeling_0.4.3          fastmap_1.2.0           grid_4.5.1             \n[34] colorspace_2.1-2        cli_3.6.5               SparseArray_1.8.1      \n[37] magrittr_2.0.4          S4Arrays_1.8.1          dichromat_2.0-0.1      \n[40] withr_3.0.2             UCSC.utils_1.4.0        scales_1.4.0           \n[43] rmarkdown_2.30          XVector_0.48.0          httr_1.4.7             \n[46] beachmat_2.24.0         evaluate_1.0.5          knitr_1.50             \n[49] rlang_1.1.6             Rcpp_1.1.0              glue_1.8.0             \n[52] rstudioapi_0.17.1       jsonlite_2.0.0          R6_2.6.1"
  },
  {
    "objectID": "code/01-fil.html#quality",
    "href": "code/01-fil.html#quality",
    "title": "fil",
    "section": "",
    "text": "# exclude cells less than 'd' from any FOV border;\n# 'd' = third radius of an average (circular) cell\nds &lt;- .d2b(colData(sce))\nmm2 &lt;- sce$Area.um2*1e-6\nth_d &lt;- mean(sqrt(mm2/pi))/3\nex_d &lt;- rowAnys(ds &lt; th_d)\n\n\n\n\n\n# exclude low-quality cells based on total counts & detected features\n.f &lt;- \\(x, n=2.5, i=sce$sid) isOutlier(x, n, \"lower\", TRUE, batch=i)\n.g &lt;- \\(x) attr(x, \"threshold\")[1, ]\n\nth_n &lt;- .g(ex_n &lt;- .f(sce$nCount_RNA))\nth_m &lt;- .g(ex_m &lt;- .f(sce$nFeature_RNA))\nth_a &lt;- .g(ex_a &lt;- .f(sce$nCount_RNA/sce$Area.um2))\n\n\n# stash thresholds\nths &lt;- data.frame(d=th_d*1e3, n=th_n, m=th_m, a=th_a)\nths &lt;- data.frame(row.names=NULL, sid=rownames(ths), ths)\nformat(metadata(sce)$ths &lt;- ths, digits=2)\n\n      sid   d   n   m     a\n1  011LNd 1.7 207 174  3.80\n2  012LNd 1.7 330 272  7.58\n3  020LNm 1.7  46  39  1.06\n4  031LNd 1.7  90  93  2.12\n5  041SOd 1.7  95  80  1.96\n6  042SOd 1.7 275 218  5.27\n7  051LNn 1.7 129 110  2.85\n8  052LNn 1.7  98  87  1.91\n9  061LNd 1.7 239 203  6.45\n10 062LNd 1.7 321 277  6.81\n11 071NPd 1.7  32  30  0.71\n12 072NPd 1.7  72  60  1.98\n13 080LNn 1.7 255 215  5.98\n14 091EYn 1.7 299 262  9.98\n15 092EYn 1.7 140 131  3.68\n16 100LNd 1.7 201 184  4.37\n17 111LNn 1.7  76  68  0.97\n18 112LNn 1.7  69  60  1.08\n19 121LNm 1.7  57  52  1.87\n20 122LNm 1.7  69  58  1.94"
  },
  {
    "objectID": "code/02-sig.html",
    "href": "code/02-sig.html",
    "title": "sig",
    "section": "",
    "text": "library(UCell)\nlibrary(AUCell)\nlibrary(readxl)\nlibrary(scuttle)\nlibrary(jsonlite)\nlibrary(BiocParallel)\nlibrary(SingleCellExperiment)\nsource(\"code/_utils.R\")\nbp &lt;- MulticoreParam(4)\nrd &lt;- character()\n\n\n\n\n\n(sce &lt;- readRDS(\"outs/fil.rds\"))\n\nclass: SingleCellExperiment \ndim: 6375 91833 \nmetadata(1): ths\nassays(1): counts\nrownames(6375): A1BG A2M ... ZYX ZZZ3\nrowData names(0):\ncolnames(91833): c_1_287_2 c_1_287_3 ... c_1_364_1960 c_1_364_1966\ncolData names(76): cell nCount_RNA ... typ sid\nreducedDimNames(0):\nmainExpName: NULL\naltExpNames(2): Negative SystemControl\n\n\n\n\n\n\n\n\ngs &lt;- fromJSON(\"data/sig/InHouse.json\")\nrd &lt;- append(rd, rep(\"in-house\", length(gs)))\nsapply(gs, length)\n\nBCR_component     BCR_blood    NFKB_blood        cMCL_s \n          127            27            18            13 \n\n\n\n\n\n\ndf &lt;- read.csv(\"data/sig/tum.csv\")\ndf &lt;- split(df, df$cluster)\ngt &lt;- lapply(df, \\(fd) {\n    o &lt;- order(fd$avg_log2FC)\n    tail(fd$gene[o], 50)\n})\nrd &lt;- append(rd, rep(\"tumor\", length(gt)))\nnames(gt) &lt;- c(\n    \"Quiescent\", \"SOX11 network\", \"Immediate-early response\", \n    \"Memory/nnMCL\", \"Reactivated memory B cell\", \"Pre/Pro B cell\", \n    \"MYC pathway\", \"BCR signaling/NFKB pathway\", \"S-Phase\", \"G2/M\")\nsapply(gt, length)\ngs &lt;- append(gs, gt)\n\n                 Quiescent              SOX11 network \n                        50                         50 \n  Immediate-early response               Memory/nnMCL \n                        50                         50 \n Reactivated memory B cell             Pre/Pro B cell \n                        50                         50 \n               MYC pathway BCR signaling/NFKB pathway \n                        50                         50 \n                   S-Phase                       G2/M \n                        50                         50 \n\n\n\n\n\n\nuse &lt;- read_xlsx(\"data/sig/sig_use.xlsx\")\nall &lt;- read.csv(\"data/sig/sig_all.csv\")\nall &lt;- split(all$Gene.symbol, all$Signature)\nuse &lt;- setdiff(use[[1]], names(gs))\ngt &lt;- all[names(all) %in% use]\nrd &lt;- append(rd, rep(\"public\", length(gt)))\nsapply(gt, length)\ngs &lt;- append(gs, gt)\n\n                         ABC_memory_B_precursor_high \n                                                 174 \n                                  BCR_up_CLL_Bernard \n                                                  32 \n                                     Immediate_early \n                                                   9 \nMemory_B_CCR6pos_Memory_B_precursor_gt_DZ_CCR6neg_LZ \n                                                  24 \n              Memory_B_gt_CCR6pos_Memory_B_precursor \n                                                  11 \n                          Myc_overexpression_1.5x_up \n                                                  89 \n\n\n\n\n\n\nurl &lt;- paste0(\n    \"https://www.gsea-msigdb.org/gsea/msigdb/human/\",\n    \"download_geneset.jsp?geneSetName=%s&fileType=json\")\nfoo &lt;- \\(set) {\n    names(set) &lt;- set\n    lapply(set, \\(.) {\n        url &lt;- sprintf(url, .)\n        tf &lt;- tempfile(fileext=\".json\")\n        download.file(url, tf, quiet=TRUE)\n        fromJSON(tf)[[1]]$geneSymbols\n    })\n}\nuse &lt;- setdiff(use, names(gs))\nsapply(gt &lt;- foo(use), length)\nrd &lt;- append(rd, rep(\"msigdb\", length(gt)))\ngs &lt;- append(gs, gt)\n\n           HAY_BONE_MARROW_CD34_POS_PRE_B \n                                      100 \n             HALLMARK_IL2_STAT5_SIGNALING \n                                      199 \n    GAVISH_3CA_METAPROGRAM_B_CELLS_MEMORY \n                                       50 \nGAVISH_3CA_METAPROGRAM_B_CELLS_PROGENITOR \n                                       50 \nGAVISH_3CA_METAPROGRAM_B_CELLS_INTERFERON \n                                       50 \n       HALLMARK_INTERFERON_ALPHA_RESPONSE \n                                       97 \n                  HALLMARK_MYC_TARGETS_V2 \n                                       58 \nGAVISH_3CA_METAPROGRAM_B_CELLS_CELL_CYCLE \n                                       47 \n                 HALLMARK_MITOTIC_SPINDLE \n                                      199 \n\n\n\n\n\n\nnm &lt;- \"data/sig/Chu2023.xlsx\"\nfor (. in names(is &lt;- c(CD4=7, CD8=5))) {\n    df &lt;- read_xlsx(nm, skip=1, sheet=is[[.]]) \n    gt &lt;- lapply(asplit(df, 2), \\(.) .[!is.na(.)])\n    rd &lt;- append(rd, rep(\"t-atlas\", length(gt)))\n    names(gt) &lt;- paste(names(gt), .)\n    gs &lt;- append(gs, gt)\n}\n\n\n# number of genes by signature\n# & intersecting with 6k panel\ngs &lt;- lapply(gt &lt;- gs, intersect, rownames(sce))\ncbind(\n    original=summary(sapply(gt, length)), \n    in_panel=summary(sapply(gs, length)))\n\n        original  in_panel\nMin.         5.0   5.00000\n1st Qu.     14.0  13.00000\nMedian      31.0  21.00000\nMean        50.4  34.35385\n3rd Qu.     50.0  37.00000\nMax.       384.0 310.00000\n\n\n\n\n\n\n\nsce &lt;- ScoreSignatures_UCell(sce, \n    features=gs, maxRank=nrow(sce), \n    name=NULL, assay=\"counts\", BPPARAM=bp)\nres &lt;- altExp(sce, \"UCell\")\ncolData(res) &lt;- colData(sce)\nrowData(res)$set &lt;- gs\nrowData(res)$typ &lt;- rd\ntable(rd); res\n\nrd\nin-house   msigdb   public  t-atlas    tumor \n       4        9        6       36       10 \n\n\nclass: SummarizedExperiment \ndim: 65 91833 \nmetadata(0):\nassays(1): UCell\nrownames(65): BCR_component BCR_blood ... Pro-apoptosis CD8\n  Anti-apoptosis CD8\nrowData names(2): set typ\ncolnames(91833): c_1_287_2 c_1_287_3 ... c_1_364_1960 c_1_364_1966\ncolData names(76): cell nCount_RNA ... typ sid\n\n\n\n\n\n\n\n\nsaveRDS(res, \"outs/sig.rds\")\n\n\n\n\n\n\n\nsession\n\n\n\n\n\n\nsessionInfo()\n\nR version 4.5.1 (2025-06-13)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS Sequoia 15.6.1\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Europe/Madrid\ntzcode source: internal\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] patchwork_1.3.2             ggplot2_4.0.0              \n [3] tidyr_1.3.1                 dplyr_1.1.4                \n [5] BiocParallel_1.42.2         jsonlite_2.0.0             \n [7] scuttle_1.18.0              SingleCellExperiment_1.30.1\n [9] SummarizedExperiment_1.38.1 Biobase_2.68.0             \n[11] GenomicRanges_1.60.0        GenomeInfoDb_1.44.3        \n[13] IRanges_2.42.0              S4Vectors_0.46.0           \n[15] BiocGenerics_0.54.1         generics_0.1.4             \n[17] MatrixGenerics_1.20.0       matrixStats_1.5.0          \n[19] readxl_1.4.5                AUCell_1.30.1              \n[21] UCell_2.12.0               \n\nloaded via a namespace (and not attached):\n [1] tidyselect_1.2.1          farver_2.1.2             \n [3] blob_1.2.4                S7_0.2.0                 \n [5] R.utils_2.13.0            Biostrings_2.76.0        \n [7] fastmap_1.2.0             XML_3.99-0.19            \n [9] digest_0.6.37             lifecycle_1.0.4          \n[11] KEGGREST_1.48.1           RSQLite_2.4.3            \n[13] magrittr_2.0.4            compiler_4.5.1           \n[15] rlang_1.1.6               tools_4.5.1              \n[17] yaml_2.3.10               data.table_1.17.8        \n[19] knitr_1.50                S4Arrays_1.8.1           \n[21] htmlwidgets_1.6.4         bit_4.6.0                \n[23] DelayedArray_0.34.1       RColorBrewer_1.1-3       \n[25] mapproj_1.2.12            abind_1.4-8              \n[27] withr_3.0.2               purrr_1.1.0              \n[29] R.oo_1.27.1               grid_4.5.1               \n[31] beachmat_2.24.0           xtable_1.8-4             \n[33] colorspace_2.1-2          scales_1.4.0             \n[35] pals_1.10                 dichromat_2.0-0.1        \n[37] cli_3.6.5                 rmarkdown_2.30           \n[39] crayon_1.5.3              rstudioapi_0.17.1        \n[41] httr_1.4.7                DelayedMatrixStats_1.30.0\n[43] DBI_1.2.3                 cachem_1.1.0             \n[45] maps_3.4.3                parallel_4.5.1           \n[47] AnnotationDbi_1.70.0      cellranger_1.1.0         \n[49] XVector_0.48.0            vctrs_0.6.5              \n[51] Matrix_1.7-4              BiocNeighbors_2.2.0      \n[53] bit64_4.6.0-1             GSEABase_1.70.1          \n[55] annotate_1.86.1           glue_1.8.0               \n[57] codetools_0.2-20          gtable_0.3.6             \n[59] UCSC.utils_1.4.0          tibble_3.3.0             \n[61] pillar_1.11.1             htmltools_0.5.8.1        \n[63] graph_1.86.0              GenomeInfoDbData_1.2.14  \n[65] R6_2.6.1                  sparseMatrixStats_1.20.0 \n[67] evaluate_1.0.5            lattice_0.22-7           \n[69] R.methodsS3_1.8.2         png_0.1-8                \n[71] memoise_2.0.1             Rcpp_1.1.0               \n[73] SparseArray_1.8.1         xfun_0.54                \n[75] pkgconfig_2.0.3"
  },
  {
    "objectID": "code/02-sig.html#preamble",
    "href": "code/02-sig.html#preamble",
    "title": "sig",
    "section": "",
    "text": "library(UCell)\nlibrary(AUCell)\nlibrary(readxl)\nlibrary(scuttle)\nlibrary(jsonlite)\nlibrary(BiocParallel)\nlibrary(SingleCellExperiment)\nsource(\"code/_utils.R\")\nbp &lt;- MulticoreParam(4)\nrd &lt;- character()"
  },
  {
    "objectID": "code/02-sig.html#loading",
    "href": "code/02-sig.html#loading",
    "title": "sig",
    "section": "",
    "text": "(sce &lt;- readRDS(\"outs/fil.rds\"))\n\nclass: SingleCellExperiment \ndim: 6375 91833 \nmetadata(1): ths\nassays(1): counts\nrownames(6375): A1BG A2M ... ZYX ZZZ3\nrowData names(0):\ncolnames(91833): c_1_287_2 c_1_287_3 ... c_1_364_1960 c_1_364_1966\ncolData names(76): cell nCount_RNA ... typ sid\nreducedDimNames(0):\nmainExpName: NULL\naltExpNames(2): Negative SystemControl"
  },
  {
    "objectID": "code/02-sig.html#sets",
    "href": "code/02-sig.html#sets",
    "title": "sig",
    "section": "",
    "text": "gs &lt;- fromJSON(\"data/sig/InHouse.json\")\nrd &lt;- append(rd, rep(\"in-house\", length(gs)))\nsapply(gs, length)\n\nBCR_component     BCR_blood    NFKB_blood        cMCL_s \n          127            27            18            13 \n\n\n\n\n\n\ndf &lt;- read.csv(\"data/sig/tum.csv\")\ndf &lt;- split(df, df$cluster)\ngt &lt;- lapply(df, \\(fd) {\n    o &lt;- order(fd$avg_log2FC)\n    tail(fd$gene[o], 50)\n})\nrd &lt;- append(rd, rep(\"tumor\", length(gt)))\nnames(gt) &lt;- c(\n    \"Quiescent\", \"SOX11 network\", \"Immediate-early response\", \n    \"Memory/nnMCL\", \"Reactivated memory B cell\", \"Pre/Pro B cell\", \n    \"MYC pathway\", \"BCR signaling/NFKB pathway\", \"S-Phase\", \"G2/M\")\nsapply(gt, length)\ngs &lt;- append(gs, gt)\n\n                 Quiescent              SOX11 network \n                        50                         50 \n  Immediate-early response               Memory/nnMCL \n                        50                         50 \n Reactivated memory B cell             Pre/Pro B cell \n                        50                         50 \n               MYC pathway BCR signaling/NFKB pathway \n                        50                         50 \n                   S-Phase                       G2/M \n                        50                         50 \n\n\n\n\n\n\nuse &lt;- read_xlsx(\"data/sig/sig_use.xlsx\")\nall &lt;- read.csv(\"data/sig/sig_all.csv\")\nall &lt;- split(all$Gene.symbol, all$Signature)\nuse &lt;- setdiff(use[[1]], names(gs))\ngt &lt;- all[names(all) %in% use]\nrd &lt;- append(rd, rep(\"public\", length(gt)))\nsapply(gt, length)\ngs &lt;- append(gs, gt)\n\n                         ABC_memory_B_precursor_high \n                                                 174 \n                                  BCR_up_CLL_Bernard \n                                                  32 \n                                     Immediate_early \n                                                   9 \nMemory_B_CCR6pos_Memory_B_precursor_gt_DZ_CCR6neg_LZ \n                                                  24 \n              Memory_B_gt_CCR6pos_Memory_B_precursor \n                                                  11 \n                          Myc_overexpression_1.5x_up \n                                                  89 \n\n\n\n\n\n\nurl &lt;- paste0(\n    \"https://www.gsea-msigdb.org/gsea/msigdb/human/\",\n    \"download_geneset.jsp?geneSetName=%s&fileType=json\")\nfoo &lt;- \\(set) {\n    names(set) &lt;- set\n    lapply(set, \\(.) {\n        url &lt;- sprintf(url, .)\n        tf &lt;- tempfile(fileext=\".json\")\n        download.file(url, tf, quiet=TRUE)\n        fromJSON(tf)[[1]]$geneSymbols\n    })\n}\nuse &lt;- setdiff(use, names(gs))\nsapply(gt &lt;- foo(use), length)\nrd &lt;- append(rd, rep(\"msigdb\", length(gt)))\ngs &lt;- append(gs, gt)\n\n           HAY_BONE_MARROW_CD34_POS_PRE_B \n                                      100 \n             HALLMARK_IL2_STAT5_SIGNALING \n                                      199 \n    GAVISH_3CA_METAPROGRAM_B_CELLS_MEMORY \n                                       50 \nGAVISH_3CA_METAPROGRAM_B_CELLS_PROGENITOR \n                                       50 \nGAVISH_3CA_METAPROGRAM_B_CELLS_INTERFERON \n                                       50 \n       HALLMARK_INTERFERON_ALPHA_RESPONSE \n                                       97 \n                  HALLMARK_MYC_TARGETS_V2 \n                                       58 \nGAVISH_3CA_METAPROGRAM_B_CELLS_CELL_CYCLE \n                                       47 \n                 HALLMARK_MITOTIC_SPINDLE \n                                      199 \n\n\n\n\n\n\nnm &lt;- \"data/sig/Chu2023.xlsx\"\nfor (. in names(is &lt;- c(CD4=7, CD8=5))) {\n    df &lt;- read_xlsx(nm, skip=1, sheet=is[[.]]) \n    gt &lt;- lapply(asplit(df, 2), \\(.) .[!is.na(.)])\n    rd &lt;- append(rd, rep(\"t-atlas\", length(gt)))\n    names(gt) &lt;- paste(names(gt), .)\n    gs &lt;- append(gs, gt)\n}\n\n\n# number of genes by signature\n# & intersecting with 6k panel\ngs &lt;- lapply(gt &lt;- gs, intersect, rownames(sce))\ncbind(\n    original=summary(sapply(gt, length)), \n    in_panel=summary(sapply(gs, length)))\n\n        original  in_panel\nMin.         5.0   5.00000\n1st Qu.     14.0  13.00000\nMedian      31.0  21.00000\nMean        50.4  34.35385\n3rd Qu.     50.0  37.00000\nMax.       384.0 310.00000"
  },
  {
    "objectID": "code/02-sig.html#scoring",
    "href": "code/02-sig.html#scoring",
    "title": "sig",
    "section": "",
    "text": "sce &lt;- ScoreSignatures_UCell(sce, \n    features=gs, maxRank=nrow(sce), \n    name=NULL, assay=\"counts\", BPPARAM=bp)\nres &lt;- altExp(sce, \"UCell\")\ncolData(res) &lt;- colData(sce)\nrowData(res)$set &lt;- gs\nrowData(res)$typ &lt;- rd\ntable(rd); res\n\nrd\nin-house   msigdb   public  t-atlas    tumor \n       4        9        6       36       10 \n\n\nclass: SummarizedExperiment \ndim: 65 91833 \nmetadata(0):\nassays(1): UCell\nrownames(65): BCR_component BCR_blood ... Pro-apoptosis CD8\n  Anti-apoptosis CD8\nrowData names(2): set typ\ncolnames(91833): c_1_287_2 c_1_287_3 ... c_1_364_1960 c_1_364_1966\ncolData names(76): cell nCount_RNA ... typ sid"
  },
  {
    "objectID": "code/02-sig.html#appendix",
    "href": "code/02-sig.html#appendix",
    "title": "sig",
    "section": "",
    "text": "saveRDS(res, \"outs/sig.rds\")\n\n\n\n\n\n\n\nsession\n\n\n\n\n\n\nsessionInfo()\n\nR version 4.5.1 (2025-06-13)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS Sequoia 15.6.1\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Europe/Madrid\ntzcode source: internal\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] patchwork_1.3.2             ggplot2_4.0.0              \n [3] tidyr_1.3.1                 dplyr_1.1.4                \n [5] BiocParallel_1.42.2         jsonlite_2.0.0             \n [7] scuttle_1.18.0              SingleCellExperiment_1.30.1\n [9] SummarizedExperiment_1.38.1 Biobase_2.68.0             \n[11] GenomicRanges_1.60.0        GenomeInfoDb_1.44.3        \n[13] IRanges_2.42.0              S4Vectors_0.46.0           \n[15] BiocGenerics_0.54.1         generics_0.1.4             \n[17] MatrixGenerics_1.20.0       matrixStats_1.5.0          \n[19] readxl_1.4.5                AUCell_1.30.1              \n[21] UCell_2.12.0               \n\nloaded via a namespace (and not attached):\n [1] tidyselect_1.2.1          farver_2.1.2             \n [3] blob_1.2.4                S7_0.2.0                 \n [5] R.utils_2.13.0            Biostrings_2.76.0        \n [7] fastmap_1.2.0             XML_3.99-0.19            \n [9] digest_0.6.37             lifecycle_1.0.4          \n[11] KEGGREST_1.48.1           RSQLite_2.4.3            \n[13] magrittr_2.0.4            compiler_4.5.1           \n[15] rlang_1.1.6               tools_4.5.1              \n[17] yaml_2.3.10               data.table_1.17.8        \n[19] knitr_1.50                S4Arrays_1.8.1           \n[21] htmlwidgets_1.6.4         bit_4.6.0                \n[23] DelayedArray_0.34.1       RColorBrewer_1.1-3       \n[25] mapproj_1.2.12            abind_1.4-8              \n[27] withr_3.0.2               purrr_1.1.0              \n[29] R.oo_1.27.1               grid_4.5.1               \n[31] beachmat_2.24.0           xtable_1.8-4             \n[33] colorspace_2.1-2          scales_1.4.0             \n[35] pals_1.10                 dichromat_2.0-0.1        \n[37] cli_3.6.5                 rmarkdown_2.30           \n[39] crayon_1.5.3              rstudioapi_0.17.1        \n[41] httr_1.4.7                DelayedMatrixStats_1.30.0\n[43] DBI_1.2.3                 cachem_1.1.0             \n[45] maps_3.4.3                parallel_4.5.1           \n[47] AnnotationDbi_1.70.0      cellranger_1.1.0         \n[49] XVector_0.48.0            vctrs_0.6.5              \n[51] Matrix_1.7-4              BiocNeighbors_2.2.0      \n[53] bit64_4.6.0-1             GSEABase_1.70.1          \n[55] annotate_1.86.1           glue_1.8.0               \n[57] codetools_0.2-20          gtable_0.3.6             \n[59] UCSC.utils_1.4.0          tibble_3.3.0             \n[61] pillar_1.11.1             htmltools_0.5.8.1        \n[63] graph_1.86.0              GenomeInfoDbData_1.2.14  \n[65] R6_2.6.1                  sparseMatrixStats_1.20.0 \n[67] evaluate_1.0.5            lattice_0.22-7           \n[69] R.methodsS3_1.8.2         png_0.1-8                \n[71] memoise_2.0.1             Rcpp_1.1.0               \n[73] SparseArray_1.8.1         xfun_0.54                \n[75] pkgconfig_2.0.3"
  },
  {
    "objectID": "code/02-ccc.html",
    "href": "code/02-ccc.html",
    "title": "ccc",
    "section": "",
    "text": "library(Matrix)\nlibrary(scater)\nlibrary(reticulate)\nlibrary(BiocParallel)\nlibrary(zellkonverter)\nlibrary(SingleCellExperiment)\nsource(\"code/_utils.R\")\nbp &lt;- MulticoreParam(8)\n# activate conda environment\nbin &lt;- \"~/software/mambaforge/bin\"\nuse_python(file.path(bin, \"python\"))\nuse_condaenv(\"commot\", file.path(bin, \"conda\"))\n\n\n\n\n\n(sce &lt;- readRDS(\"outs/fil.rds\"))\n\nclass: SingleCellExperiment \ndim: 6375 91833 \nmetadata(1): ths\nassays(1): counts\nrownames(6375): A1BG A2M ... ZYX ZZZ3\nrowData names(0):\ncolnames(91833): c_1_287_2 c_1_287_3 ... c_1_364_1960 c_1_364_1966\ncolData names(76): cell nCount_RNA ... typ sid\nreducedDimNames(0):\nmainExpName: NULL\naltExpNames(2): Negative SystemControl\n\n\n\n# wrangling\nxy &lt;- grep(\"global_mm$\", names(colData(sce)))\nxy &lt;- as.matrix(colData(sce)[xy])\nreducedDim(sce, \"spatial\") &lt;- xy\nsce &lt;- logNormCounts(sce)\n\n\n\n\n\n\n\n# dependencies\nad &lt;- import(\"anndata\")\nct &lt;- import(\"commot\")\npd &lt;- import(\"pandas\")\n\n# retrieve interactions from 'CellChatDB'\ndb &lt;- ct$pp$ligand_receptor_database(\n    species=\"human\", \n    database=\"CellChat\", \n    signaling_type=NULL)\nnames(db) &lt;- c(\n    \"ligand\", \"receptor\", \n    \"pathway\", \"type\")\nnrow(db)\n\n[1] 1939\n\n# filter for interactions\n# fully covered by panel\ndb &lt;- db[apply(db, 1, \\(.) {\n    rs &lt;- strsplit(.[\"receptor\"], \"_\")\n    lr &lt;- c(.[\"ligand\"], unlist(rs))\n    all(lr %in% rownames(sce))\n}), ]\nnrow(db)\n\n[1] 1356\n\n# subset to features being considered\nrs &lt;- sapply(strsplit(db$receptor, \"_\"), .subset, 1)\nnrow(sub &lt;- sce[unique(c(db$ligand, rs)), ])\n\n[1] 650\n\n\n\n\n\n\nset.seed(251205)\nbo &lt;- bpoptions(progressbar=TRUE)\ncs &lt;- split(colnames(sce), sce$fov)\nsr &lt;- bplapply(\n    BPPARAM=bp, BPOPTIONS=bo, \n    names(cs), \\(f) {\n        tryCatch(error=\\(e) e, {\n            ad &lt;- SCE2AnnData(\n                sce=sub[, cs[[f]]], \n                X_name=\"logcounts\")\n            ct$tl$spatial_communication(ad,\n                dis_thr=0.02,  \n                df_ligrec=db,\n                heteromeric=TRUE,\n                pathway_sum=TRUE,\n                database_name=\"foo\",\n                heteromeric_rule=\"min\",\n                heteromeric_delimiter=\"_\")\n            list(\n                ad$obsm[\"commot-foo-sum-sender\"], \n                ad$obsm[\"commot-foo-sum-receiver\"])\n        })\n    })\n\n\n  |                                                                            \n  |                                                                      |   0%\n  |                                                                            \n  |====                                                                  |   5%\n  |                                                                            \n  |=============                                                         |  19%\n  |                                                                            \n  |=======================                                               |  32%\n  |                                                                            \n  |================================                                      |  46%\n  |                                                                            \n  |==========================================                            |  59%\n  |                                                                            \n  |===================================================                   |  73%\n  |                                                                            \n  |=============================================================         |  86%\n  |                                                                            \n  |======================================================================| 100%\n\ner &lt;- sapply(sr, inherits, \"error\")\nex &lt;- sapply(sr, is.null)\ntable(na &lt;- er | ex)\n\n\nFALSE \n   74 \n\nsr &lt;- sr[!na]\n\n\n\n\n\n# reformatting\ni &lt;- colnames(sce)\ns &lt;- lapply(sr, \\(.) .[[1]])\nr &lt;- lapply(sr, \\(.) .[[2]])\ns &lt;- do.call(rbind, unname(s))\nr &lt;- do.call(rbind, unname(r))\nres &lt;- list(s=s[i, ], r=r[i, ])\nres &lt;- lapply(res, \\(.) {\n    mtx &lt;- as(as.matrix(.), \"dgCMatrix\")\n    nms &lt;- gsub(\"^(s|r)-\", \"\", colnames(.))\n    `colnames&lt;-`(mtx, nms)\n})\n# more reformatting\nres &lt;- SingleCellExperiment(\n    assays=lapply(res, t), \n    colData=colData(sce))\ntyp &lt;- ifelse(grepl(\"-\", rownames(res)), \"lr\", \"pw\")\ntyp[grep(\"total\", rownames(res))] &lt;- \"tt\"\nrowData(res) &lt;- data.frame(typ)\nres\n\nclass: SingleCellExperiment \ndim: 1063 91833 \nmetadata(0):\nassays(2): s r\nrownames(1063): COL4A6-ITGA2_ITGB1 COL4A6-GP6 ... VTN ncWNT\nrowData names(1): typ\ncolnames(91833): c_1_287_2 c_1_287_3 ... c_1_364_1960 c_1_364_1966\ncolData names(77): cell nCount_RNA ... sid sizeFactor\nreducedDimNames(0):\nmainExpName: NULL\naltExpNames(0):\n\n\n\n\n\n\n\n\n\nsaveRDS(res, \"outs/ccc.rds\")\n\n\n\n\n\n\n\nsession\n\n\n\n\n\n\nsessionInfo()\n\nR version 4.5.1 (2025-06-13)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS Sequoia 15.6.1\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Europe/Madrid\ntzcode source: internal\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] patchwork_1.3.2             tidyr_1.3.1                \n [3] dplyr_1.1.4                 zellkonverter_1.18.0       \n [5] BiocParallel_1.42.2         reticulate_1.44.0          \n [7] scater_1.36.0               ggplot2_4.0.0              \n [9] scuttle_1.18.0              SingleCellExperiment_1.30.1\n[11] SummarizedExperiment_1.38.1 Biobase_2.68.0             \n[13] GenomicRanges_1.60.0        GenomeInfoDb_1.44.3        \n[15] IRanges_2.42.0              S4Vectors_0.46.0           \n[17] BiocGenerics_0.54.1         generics_0.1.4             \n[19] MatrixGenerics_1.20.0       matrixStats_1.5.0          \n[21] Matrix_1.7-4               \n\nloaded via a namespace (and not attached):\n [1] tidyselect_1.2.1        viridisLite_0.4.2       vipor_0.4.7            \n [4] farver_2.1.2            filelock_1.0.3          viridis_0.6.5          \n [7] S7_0.2.0                fastmap_1.2.0           digest_0.6.37          \n[10] rsvd_1.0.5              lifecycle_1.0.4         magrittr_2.0.4         \n[13] compiler_4.5.1          rlang_1.1.6             tools_4.5.1            \n[16] yaml_2.3.10             knitr_1.50              S4Arrays_1.8.1         \n[19] htmlwidgets_1.6.4       DelayedArray_0.34.1     mapproj_1.2.12         \n[22] RColorBrewer_1.1-3      abind_1.4-8             withr_3.0.2            \n[25] purrr_1.1.0             grid_4.5.1              beachmat_2.24.0        \n[28] colorspace_2.1-2        scales_1.4.0            pals_1.10              \n[31] dichromat_2.0-0.1       cli_3.6.5               rmarkdown_2.30         \n[34] crayon_1.5.3            rstudioapi_0.17.1       httr_1.4.7             \n[37] ggbeeswarm_0.7.2        maps_3.4.3              parallel_4.5.1         \n[40] XVector_0.48.0          basilisk_1.20.0         vctrs_0.6.5            \n[43] jsonlite_2.0.0          dir.expiry_1.16.0       BiocSingular_1.24.0    \n[46] BiocNeighbors_2.2.0     ggrepel_0.9.6           irlba_2.3.5.1          \n[49] beeswarm_0.4.0          glue_1.8.0              codetools_0.2-20       \n[52] gtable_0.3.6            UCSC.utils_1.4.0        ScaledMatrix_1.16.0    \n[55] tibble_3.3.0            pillar_1.11.1           basilisk.utils_1.20.0  \n[58] htmltools_0.5.8.1       GenomeInfoDbData_1.2.14 R6_2.6.1               \n[61] evaluate_1.0.5          lattice_0.22-7          png_0.1-8              \n[64] Rcpp_1.1.0              gridExtra_2.3           SparseArray_1.8.1      \n[67] xfun_0.54               pkgconfig_2.0.3"
  },
  {
    "objectID": "code/02-ccc.html#preamble",
    "href": "code/02-ccc.html#preamble",
    "title": "ccc",
    "section": "",
    "text": "library(Matrix)\nlibrary(scater)\nlibrary(reticulate)\nlibrary(BiocParallel)\nlibrary(zellkonverter)\nlibrary(SingleCellExperiment)\nsource(\"code/_utils.R\")\nbp &lt;- MulticoreParam(8)\n# activate conda environment\nbin &lt;- \"~/software/mambaforge/bin\"\nuse_python(file.path(bin, \"python\"))\nuse_condaenv(\"commot\", file.path(bin, \"conda\"))"
  },
  {
    "objectID": "code/02-ccc.html#loading",
    "href": "code/02-ccc.html#loading",
    "title": "ccc",
    "section": "",
    "text": "(sce &lt;- readRDS(\"outs/fil.rds\"))\n\nclass: SingleCellExperiment \ndim: 6375 91833 \nmetadata(1): ths\nassays(1): counts\nrownames(6375): A1BG A2M ... ZYX ZZZ3\nrowData names(0):\ncolnames(91833): c_1_287_2 c_1_287_3 ... c_1_364_1960 c_1_364_1966\ncolData names(76): cell nCount_RNA ... typ sid\nreducedDimNames(0):\nmainExpName: NULL\naltExpNames(2): Negative SystemControl\n\n\n\n# wrangling\nxy &lt;- grep(\"global_mm$\", names(colData(sce)))\nxy &lt;- as.matrix(colData(sce)[xy])\nreducedDim(sce, \"spatial\") &lt;- xy\nsce &lt;- logNormCounts(sce)"
  },
  {
    "objectID": "code/02-ccc.html#analysis",
    "href": "code/02-ccc.html#analysis",
    "title": "ccc",
    "section": "",
    "text": "# dependencies\nad &lt;- import(\"anndata\")\nct &lt;- import(\"commot\")\npd &lt;- import(\"pandas\")\n\n# retrieve interactions from 'CellChatDB'\ndb &lt;- ct$pp$ligand_receptor_database(\n    species=\"human\", \n    database=\"CellChat\", \n    signaling_type=NULL)\nnames(db) &lt;- c(\n    \"ligand\", \"receptor\", \n    \"pathway\", \"type\")\nnrow(db)\n\n[1] 1939\n\n# filter for interactions\n# fully covered by panel\ndb &lt;- db[apply(db, 1, \\(.) {\n    rs &lt;- strsplit(.[\"receptor\"], \"_\")\n    lr &lt;- c(.[\"ligand\"], unlist(rs))\n    all(lr %in% rownames(sce))\n}), ]\nnrow(db)\n\n[1] 1356\n\n# subset to features being considered\nrs &lt;- sapply(strsplit(db$receptor, \"_\"), .subset, 1)\nnrow(sub &lt;- sce[unique(c(db$ligand, rs)), ])\n\n[1] 650\n\n\n\n\n\n\nset.seed(251205)\nbo &lt;- bpoptions(progressbar=TRUE)\ncs &lt;- split(colnames(sce), sce$fov)\nsr &lt;- bplapply(\n    BPPARAM=bp, BPOPTIONS=bo, \n    names(cs), \\(f) {\n        tryCatch(error=\\(e) e, {\n            ad &lt;- SCE2AnnData(\n                sce=sub[, cs[[f]]], \n                X_name=\"logcounts\")\n            ct$tl$spatial_communication(ad,\n                dis_thr=0.02,  \n                df_ligrec=db,\n                heteromeric=TRUE,\n                pathway_sum=TRUE,\n                database_name=\"foo\",\n                heteromeric_rule=\"min\",\n                heteromeric_delimiter=\"_\")\n            list(\n                ad$obsm[\"commot-foo-sum-sender\"], \n                ad$obsm[\"commot-foo-sum-receiver\"])\n        })\n    })\n\n\n  |                                                                            \n  |                                                                      |   0%\n  |                                                                            \n  |====                                                                  |   5%\n  |                                                                            \n  |=============                                                         |  19%\n  |                                                                            \n  |=======================                                               |  32%\n  |                                                                            \n  |================================                                      |  46%\n  |                                                                            \n  |==========================================                            |  59%\n  |                                                                            \n  |===================================================                   |  73%\n  |                                                                            \n  |=============================================================         |  86%\n  |                                                                            \n  |======================================================================| 100%\n\ner &lt;- sapply(sr, inherits, \"error\")\nex &lt;- sapply(sr, is.null)\ntable(na &lt;- er | ex)\n\n\nFALSE \n   74 \n\nsr &lt;- sr[!na]\n\n\n\n\n\n# reformatting\ni &lt;- colnames(sce)\ns &lt;- lapply(sr, \\(.) .[[1]])\nr &lt;- lapply(sr, \\(.) .[[2]])\ns &lt;- do.call(rbind, unname(s))\nr &lt;- do.call(rbind, unname(r))\nres &lt;- list(s=s[i, ], r=r[i, ])\nres &lt;- lapply(res, \\(.) {\n    mtx &lt;- as(as.matrix(.), \"dgCMatrix\")\n    nms &lt;- gsub(\"^(s|r)-\", \"\", colnames(.))\n    `colnames&lt;-`(mtx, nms)\n})\n# more reformatting\nres &lt;- SingleCellExperiment(\n    assays=lapply(res, t), \n    colData=colData(sce))\ntyp &lt;- ifelse(grepl(\"-\", rownames(res)), \"lr\", \"pw\")\ntyp[grep(\"total\", rownames(res))] &lt;- \"tt\"\nrowData(res) &lt;- data.frame(typ)\nres\n\nclass: SingleCellExperiment \ndim: 1063 91833 \nmetadata(0):\nassays(2): s r\nrownames(1063): COL4A6-ITGA2_ITGB1 COL4A6-GP6 ... VTN ncWNT\nrowData names(1): typ\ncolnames(91833): c_1_287_2 c_1_287_3 ... c_1_364_1960 c_1_364_1966\ncolData names(77): cell nCount_RNA ... sid sizeFactor\nreducedDimNames(0):\nmainExpName: NULL\naltExpNames(0):"
  },
  {
    "objectID": "code/02-ccc.html#appendix",
    "href": "code/02-ccc.html#appendix",
    "title": "ccc",
    "section": "",
    "text": "saveRDS(res, \"outs/ccc.rds\")\n\n\n\n\n\n\n\nsession\n\n\n\n\n\n\nsessionInfo()\n\nR version 4.5.1 (2025-06-13)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS Sequoia 15.6.1\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Europe/Madrid\ntzcode source: internal\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] patchwork_1.3.2             tidyr_1.3.1                \n [3] dplyr_1.1.4                 zellkonverter_1.18.0       \n [5] BiocParallel_1.42.2         reticulate_1.44.0          \n [7] scater_1.36.0               ggplot2_4.0.0              \n [9] scuttle_1.18.0              SingleCellExperiment_1.30.1\n[11] SummarizedExperiment_1.38.1 Biobase_2.68.0             \n[13] GenomicRanges_1.60.0        GenomeInfoDb_1.44.3        \n[15] IRanges_2.42.0              S4Vectors_0.46.0           \n[17] BiocGenerics_0.54.1         generics_0.1.4             \n[19] MatrixGenerics_1.20.0       matrixStats_1.5.0          \n[21] Matrix_1.7-4               \n\nloaded via a namespace (and not attached):\n [1] tidyselect_1.2.1        viridisLite_0.4.2       vipor_0.4.7            \n [4] farver_2.1.2            filelock_1.0.3          viridis_0.6.5          \n [7] S7_0.2.0                fastmap_1.2.0           digest_0.6.37          \n[10] rsvd_1.0.5              lifecycle_1.0.4         magrittr_2.0.4         \n[13] compiler_4.5.1          rlang_1.1.6             tools_4.5.1            \n[16] yaml_2.3.10             knitr_1.50              S4Arrays_1.8.1         \n[19] htmlwidgets_1.6.4       DelayedArray_0.34.1     mapproj_1.2.12         \n[22] RColorBrewer_1.1-3      abind_1.4-8             withr_3.0.2            \n[25] purrr_1.1.0             grid_4.5.1              beachmat_2.24.0        \n[28] colorspace_2.1-2        scales_1.4.0            pals_1.10              \n[31] dichromat_2.0-0.1       cli_3.6.5               rmarkdown_2.30         \n[34] crayon_1.5.3            rstudioapi_0.17.1       httr_1.4.7             \n[37] ggbeeswarm_0.7.2        maps_3.4.3              parallel_4.5.1         \n[40] XVector_0.48.0          basilisk_1.20.0         vctrs_0.6.5            \n[43] jsonlite_2.0.0          dir.expiry_1.16.0       BiocSingular_1.24.0    \n[46] BiocNeighbors_2.2.0     ggrepel_0.9.6           irlba_2.3.5.1          \n[49] beeswarm_0.4.0          glue_1.8.0              codetools_0.2-20       \n[52] gtable_0.3.6            UCSC.utils_1.4.0        ScaledMatrix_1.16.0    \n[55] tibble_3.3.0            pillar_1.11.1           basilisk.utils_1.20.0  \n[58] htmltools_0.5.8.1       GenomeInfoDbData_1.2.14 R6_2.6.1               \n[61] evaluate_1.0.5          lattice_0.22-7          png_0.1-8              \n[64] Rcpp_1.1.0              gridExtra_2.3           SparseArray_1.8.1      \n[67] xfun_0.54               pkgconfig_2.0.3"
  },
  {
    "objectID": "code/02-ist.html",
    "href": "code/02-ist.html",
    "title": "ist",
    "section": "",
    "text": "library(scuttle)\nlibrary(HDF5Array)\nlibrary(SingleCellExperiment)\nsource(\"code/_utils.R\")\nset.seed(251103)\n\n\n\n\n\n(sce &lt;- readRDS(\"outs/fil.rds\"))\n\nclass: SingleCellExperiment \ndim: 6375 91833 \nmetadata(1): ths\nassays(1): counts\nrownames(6375): A1BG A2M ... ZYX ZZZ3\nrowData names(0):\ncolnames(91833): c_1_287_2 c_1_287_3 ... c_1_364_1960 c_1_364_1966\ncolData names(76): cell nCount_RNA ... typ sid\nreducedDimNames(0):\nmainExpName: NULL\naltExpNames(2): Negative SystemControl\n\ndim(pbs &lt;- readRDS(\"outs/pbs.rds\"))\n\n[1] 36190     3\n\n\n\n\n\n\nist &lt;- .ist(sce, pbs=pbs, nk=c(4, 8), ns=c(1e4, 2e4, 1e5)/2)\n\n\nks &lt;- intersect(letters, unique(ist$clust))\nks &lt;- c(ks, sort(colnames(pbs)))\nist$clust &lt;- factor(ist$clust, ks)\ntable(ist$clust); nlevels(ist$clust)\n\n\n    a     b     c     d     e     f     g     h   mye   nkt   tum \n18916  8751  3657  2803  8773  7495  5867  7075  3091  9550 15855 \n\n\n[1] 11\n\n\n\n\n\n\n.plt_fp(ist)\n\n\n\n\n\n\n\n\n\n\nCode\nsce$ist &lt;- (kid &lt;- ist$clust)[match(colnames(sce), names(kid))]\n.plt_fq(sce, \"sid\", \"ist\", id=\"all\", h=TRUE) + theme(aspect.ratio=1) \n\n\n\n\n\n\n\n\n\n\nallabcdefghmyenkttum\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nlab &lt;- list(\n    tum=c(\"tum\", \"a\", \"b\", \"c\", \"g\", \"h\"),\n    nkt=\"nkt\", mye=c(\"mye\", \"e\"), str=c(\"d\", \"f\"))\njst &lt;- .jst(ist, lab)\ntable(ist$clust, jst$clust)\n\n     \n        mye   nkt   str   tum\n  a       0     0     0 18916\n  b       0     0     0  8751\n  c       0     0     0  3657\n  d       0     0  2803     0\n  e    8773     0     0     0\n  f       0     0  7495     0\n  g       0     0     0  5867\n  h       0     0     0  7075\n  mye  3091     0     0     0\n  nkt     0  9550     0     0\n  tum     0     0     0 15855\n\n(ns &lt;- table(jst$clust))\n\n\n  mye   nkt   str   tum \n11864  9550 10298 60121 \n\nround(100*prop.table(ns), 2)\n\n\n  mye   nkt   str   tum \n12.92 10.40 11.21 65.47 \n\n\n\n\n\n\n\n\nsaveRDS(ist, \"outs/ist.rds\")\nsaveRDS(jst, \"outs/lv1.rds\")\n\n\n\n\n\n\n\nsession\n\n\n\n\n\n\nsessionInfo()\n\nR version 4.5.1 (2025-06-13)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS Sequoia 15.6.1\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Europe/Madrid\ntzcode source: internal\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] scran_1.36.0                InSituType_2.0             \n [3] patchwork_1.3.2             ggplot2_4.0.0              \n [5] tidyr_1.3.1                 dplyr_1.1.4                \n [7] HDF5Array_1.36.0            h5mread_1.0.1              \n [9] rhdf5_2.52.1                DelayedArray_0.34.1        \n[11] SparseArray_1.8.1           S4Arrays_1.8.1             \n[13] abind_1.4-8                 Matrix_1.7-4               \n[15] scuttle_1.18.0              SingleCellExperiment_1.30.1\n[17] SummarizedExperiment_1.38.1 Biobase_2.68.0             \n[19] GenomicRanges_1.60.0        GenomeInfoDb_1.44.3        \n[21] IRanges_2.42.0              S4Vectors_0.46.0           \n[23] BiocGenerics_0.54.1         generics_0.1.4             \n[25] MatrixGenerics_1.20.0       matrixStats_1.5.0          \n\nloaded via a namespace (and not attached):\n [1] deldir_2.0-4            rlang_1.1.6             magrittr_2.0.4         \n [4] compiler_4.5.1          spatstat.geom_3.6-0     png_0.1-8              \n [7] vctrs_0.6.5             maps_3.4.3              pkgconfig_2.0.3        \n[10] crayon_1.5.3            fastmap_1.2.0           XVector_0.48.0         \n[13] labeling_0.4.3          rmarkdown_2.30          UCSC.utils_1.4.0       \n[16] ggbeeswarm_0.7.2        purrr_1.1.0             xfun_0.54              \n[19] bluster_1.18.0          pals_1.10               beachmat_2.24.0        \n[22] jsonlite_2.0.0          SnowballC_0.7.1         rhdf5filters_1.20.0    \n[25] spatstat.utils_3.2-0    Rhdf5lib_1.30.0         BiocParallel_1.42.2    \n[28] cluster_2.1.8.1         irlba_2.3.5.1           parallel_4.5.1         \n[31] R6_2.6.1                RColorBrewer_1.1-3      spatstat.data_3.1-9    \n[34] limma_3.64.3            reticulate_1.44.0       spatstat.univar_3.1-4  \n[37] Rcpp_1.1.0              knitr_1.50              igraph_2.2.1           \n[40] tidyselect_1.2.1        rstudioapi_0.17.1       dichromat_2.0-0.1      \n[43] yaml_2.3.10             codetools_0.2-20        lattice_0.22-7         \n[46] tibble_3.3.0            withr_3.0.2             S7_0.2.0               \n[49] askpass_1.2.1           evaluate_1.0.5          ggrastr_1.0.2          \n[52] polyclip_1.10-7         mclust_6.1.2            pillar_1.11.1          \n[55] lsa_0.73.3              scales_1.4.0            glue_1.8.0             \n[58] metapod_1.16.0          mapproj_1.2.12          tools_4.5.1            \n[61] BiocNeighbors_2.2.0     data.table_1.17.8       ScaledMatrix_1.16.0    \n[64] RSpectra_0.16-2         locfit_1.5-9.12         grid_4.5.1             \n[67] Cairo_1.7-0             umap_0.2.10.0           edgeR_4.6.3            \n[70] colorspace_2.1-2        GenomeInfoDbData_1.2.14 beeswarm_0.4.0         \n[73] BiocSingular_1.24.0     vipor_0.4.7             cli_3.6.5              \n[76] rsvd_1.0.5              uwot_0.2.3              gtable_0.3.6           \n[79] digest_0.6.37           dqrng_0.4.1             htmlwidgets_1.6.4      \n[82] farver_2.1.2            htmltools_0.5.8.1       lifecycle_1.0.4        \n[85] httr_1.4.7              statmod_1.5.1           openssl_2.3.4"
  },
  {
    "objectID": "code/02-ist.html#preamble",
    "href": "code/02-ist.html#preamble",
    "title": "ist",
    "section": "",
    "text": "library(scuttle)\nlibrary(HDF5Array)\nlibrary(SingleCellExperiment)\nsource(\"code/_utils.R\")\nset.seed(251103)"
  },
  {
    "objectID": "code/02-ist.html#loading",
    "href": "code/02-ist.html#loading",
    "title": "ist",
    "section": "",
    "text": "(sce &lt;- readRDS(\"outs/fil.rds\"))\n\nclass: SingleCellExperiment \ndim: 6375 91833 \nmetadata(1): ths\nassays(1): counts\nrownames(6375): A1BG A2M ... ZYX ZZZ3\nrowData names(0):\ncolnames(91833): c_1_287_2 c_1_287_3 ... c_1_364_1960 c_1_364_1966\ncolData names(76): cell nCount_RNA ... typ sid\nreducedDimNames(0):\nmainExpName: NULL\naltExpNames(2): Negative SystemControl\n\ndim(pbs &lt;- readRDS(\"outs/pbs.rds\"))\n\n[1] 36190     3"
  },
  {
    "objectID": "code/02-ist.html#clustering",
    "href": "code/02-ist.html#clustering",
    "title": "ist",
    "section": "",
    "text": "ist &lt;- .ist(sce, pbs=pbs, nk=c(4, 8), ns=c(1e4, 2e4, 1e5)/2)\n\n\nks &lt;- intersect(letters, unique(ist$clust))\nks &lt;- c(ks, sort(colnames(pbs)))\nist$clust &lt;- factor(ist$clust, ks)\ntable(ist$clust); nlevels(ist$clust)\n\n\n    a     b     c     d     e     f     g     h   mye   nkt   tum \n18916  8751  3657  2803  8773  7495  5867  7075  3091  9550 15855 \n\n\n[1] 11"
  },
  {
    "objectID": "code/02-ist.html#visuals",
    "href": "code/02-ist.html#visuals",
    "title": "ist",
    "section": "",
    "text": ".plt_fp(ist)\n\n\n\n\n\n\n\n\n\n\nCode\nsce$ist &lt;- (kid &lt;- ist$clust)[match(colnames(sce), names(kid))]\n.plt_fq(sce, \"sid\", \"ist\", id=\"all\", h=TRUE) + theme(aspect.ratio=1) \n\n\n\n\n\n\n\n\n\n\nallabcdefghmyenkttum"
  },
  {
    "objectID": "code/02-ist.html#labeling",
    "href": "code/02-ist.html#labeling",
    "title": "ist",
    "section": "",
    "text": "lab &lt;- list(\n    tum=c(\"tum\", \"a\", \"b\", \"c\", \"g\", \"h\"),\n    nkt=\"nkt\", mye=c(\"mye\", \"e\"), str=c(\"d\", \"f\"))\njst &lt;- .jst(ist, lab)\ntable(ist$clust, jst$clust)\n\n     \n        mye   nkt   str   tum\n  a       0     0     0 18916\n  b       0     0     0  8751\n  c       0     0     0  3657\n  d       0     0  2803     0\n  e    8773     0     0     0\n  f       0     0  7495     0\n  g       0     0     0  5867\n  h       0     0     0  7075\n  mye  3091     0     0     0\n  nkt     0  9550     0     0\n  tum     0     0     0 15855\n\n(ns &lt;- table(jst$clust))\n\n\n  mye   nkt   str   tum \n11864  9550 10298 60121 \n\nround(100*prop.table(ns), 2)\n\n\n  mye   nkt   str   tum \n12.92 10.40 11.21 65.47"
  },
  {
    "objectID": "code/02-ist.html#appendix",
    "href": "code/02-ist.html#appendix",
    "title": "ist",
    "section": "",
    "text": "saveRDS(ist, \"outs/ist.rds\")\nsaveRDS(jst, \"outs/lv1.rds\")\n\n\n\n\n\n\n\nsession\n\n\n\n\n\n\nsessionInfo()\n\nR version 4.5.1 (2025-06-13)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS Sequoia 15.6.1\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Europe/Madrid\ntzcode source: internal\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] scran_1.36.0                InSituType_2.0             \n [3] patchwork_1.3.2             ggplot2_4.0.0              \n [5] tidyr_1.3.1                 dplyr_1.1.4                \n [7] HDF5Array_1.36.0            h5mread_1.0.1              \n [9] rhdf5_2.52.1                DelayedArray_0.34.1        \n[11] SparseArray_1.8.1           S4Arrays_1.8.1             \n[13] abind_1.4-8                 Matrix_1.7-4               \n[15] scuttle_1.18.0              SingleCellExperiment_1.30.1\n[17] SummarizedExperiment_1.38.1 Biobase_2.68.0             \n[19] GenomicRanges_1.60.0        GenomeInfoDb_1.44.3        \n[21] IRanges_2.42.0              S4Vectors_0.46.0           \n[23] BiocGenerics_0.54.1         generics_0.1.4             \n[25] MatrixGenerics_1.20.0       matrixStats_1.5.0          \n\nloaded via a namespace (and not attached):\n [1] deldir_2.0-4            rlang_1.1.6             magrittr_2.0.4         \n [4] compiler_4.5.1          spatstat.geom_3.6-0     png_0.1-8              \n [7] vctrs_0.6.5             maps_3.4.3              pkgconfig_2.0.3        \n[10] crayon_1.5.3            fastmap_1.2.0           XVector_0.48.0         \n[13] labeling_0.4.3          rmarkdown_2.30          UCSC.utils_1.4.0       \n[16] ggbeeswarm_0.7.2        purrr_1.1.0             xfun_0.54              \n[19] bluster_1.18.0          pals_1.10               beachmat_2.24.0        \n[22] jsonlite_2.0.0          SnowballC_0.7.1         rhdf5filters_1.20.0    \n[25] spatstat.utils_3.2-0    Rhdf5lib_1.30.0         BiocParallel_1.42.2    \n[28] cluster_2.1.8.1         irlba_2.3.5.1           parallel_4.5.1         \n[31] R6_2.6.1                RColorBrewer_1.1-3      spatstat.data_3.1-9    \n[34] limma_3.64.3            reticulate_1.44.0       spatstat.univar_3.1-4  \n[37] Rcpp_1.1.0              knitr_1.50              igraph_2.2.1           \n[40] tidyselect_1.2.1        rstudioapi_0.17.1       dichromat_2.0-0.1      \n[43] yaml_2.3.10             codetools_0.2-20        lattice_0.22-7         \n[46] tibble_3.3.0            withr_3.0.2             S7_0.2.0               \n[49] askpass_1.2.1           evaluate_1.0.5          ggrastr_1.0.2          \n[52] polyclip_1.10-7         mclust_6.1.2            pillar_1.11.1          \n[55] lsa_0.73.3              scales_1.4.0            glue_1.8.0             \n[58] metapod_1.16.0          mapproj_1.2.12          tools_4.5.1            \n[61] BiocNeighbors_2.2.0     data.table_1.17.8       ScaledMatrix_1.16.0    \n[64] RSpectra_0.16-2         locfit_1.5-9.12         grid_4.5.1             \n[67] Cairo_1.7-0             umap_0.2.10.0           edgeR_4.6.3            \n[70] colorspace_2.1-2        GenomeInfoDbData_1.2.14 beeswarm_0.4.0         \n[73] BiocSingular_1.24.0     vipor_0.4.7             cli_3.6.5              \n[76] rsvd_1.0.5              uwot_0.2.3              gtable_0.3.6           \n[79] digest_0.6.37           dqrng_0.4.1             htmlwidgets_1.6.4      \n[82] farver_2.1.2            htmltools_0.5.8.1       lifecycle_1.0.4        \n[85] httr_1.4.7              statmod_1.5.1           openssl_2.3.4"
  }
]