[
  {
    "objectID": "code/index.html",
    "href": "code/index.html",
    "title": "toc",
    "section": "",
    "text": "toc\n\npseudobulks\nsetup\n\nadd core-level metadata\nwrite polygons to .parquet\nformat into SingleCellExperiment\nnegative & false codes as altExps\n\nfiltering\n\nbased on cell-level metrics\n& distance to FOV borders\n\nsignatures\n\nMSigDB, in-house, public\n& pan-cancer T cell atlas\n\nsignaling\n\nusing COMMOT\n\nclustering\n\nsemi-supervised for all but stromal\nsplit into NK/T, myeloid stromal & tumor cells\n\nsubclustering’’\n\nsemi-supervised for all but stroml\nsubset-specific feature selection\n\ncontexts\n\ncluster cells based on composition\nof 20um radial neighborhoods\n\nprocessing\n\npooling of all previousresults\ndimensionality reduction (joint & split)\n\nEDA signatures\nEDA signaling"
  },
  {
    "objectID": "code/00-ref.html",
    "href": "code/00-ref.html",
    "title": "ref",
    "section": "",
    "text": "library(qs)\nlibrary(Seurat)\nlibrary(scuttle)\nlibrary(SingleCellExperiment)\nsource(\"code/_utils.R\")\n\n\n\n\n\nqs &lt;- list.files(\"data/ref\", \"qs$\", full.names=TRUE)\nnames(qs) &lt;- gsub(\"\\\\.qs\", \"\", basename(qs))\nse &lt;- lapply(qs, \\(.) {\n    so &lt;- qread(.)\n    se &lt;- as.SingleCellExperiment(so)\n    logcounts(se) &lt;- NULL\n    reducedDims(se) &lt;- list()\n    gs &lt;- VariableFeatures(so)\n    gs &lt;- rownames(se) %in% gs\n    rowData(se)$hvg &lt;- gs\n    se\n}); sapply(se, ncol)\n\n   mye    nkt    tum \n 48047 174677 151264 \n\n\n\n\n\n\nold &lt;- c(\"0\",\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"11\")\nnew &lt;- c(\n    \"Classical_monocytes\", \"Class. monocytes_HLA\", \n    \"Non-class. monocytes\", \"Class. monocytes_SELL\", \n    \"Class. monocytes_ribo\", \"DC2\", \"Class. monocytes_IFNresp\", \n    \"pDC_1\", \"Progenitor cells\", \"Platelets\", \"pDC_2\", \"DC1\")\nnev &lt;- list(\n    mono.c=c(\"Classical_monocytes\",\n        \"Class. monocytes_SELL\", \"Class. monocytes_HLA\",\n        \"Class. monocytes_ribo\", \"Class. monocytes_IFNresp\"),\n    mono.nc=\"Non-class. monocytes\",\n    pDC=c(\"pDC_2\", \"pDC_1\"),\n    DC=c(\"DC1\", \"DC2\"))\nnev &lt;- setNames(rep.int(names(nev), sapply(nev, length)), unlist(nev))\nlab &lt;- new[match(se$mye$ident, old)]\nlab &lt;- nev[match(lab, names(nev))]\ntable(se$mye$lab &lt;- lab, exclude=NULL)\n\n\n     DC  mono.c mono.nc     pDC    &lt;NA&gt; \n   3141   32819    8632    2230    1225 \n\n\n\nold &lt;- c(\"0\",\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"11\",\"12\",\"13\",\"14\",\"15\",\"17\",\"18\")\nnew &lt;- c(\n    \"CD16pos NK\",\"CD4 TCM TFH\",\"TEMRA\",\"CD4 TN\",\"CD8 TPEX\",\"CD4 TREG\",\n    \"CD4 TCM TH2\",\"NK-like T\",\"NK/ILC\",\"CD8 TEX\",\"CD4 TCM\",\"CD8 TEM\",\n    \"CD16neg NK\",\"CD8 TN\",\"MAIT\",\"Cycling T\",\"IFN responding\")\nnev &lt;- list(\n    \"NK/ILC\"=c(\"CD16neg NK\", \"CD16pos NK\", \"NK ILC3\"),\n    Tcm=c(\"CD4 TCM_TH2\", \"CD4 TCM\"),\n    Tex=c(\"CD8 TPEX\", \"CD8 TEX\"),\n    Tc=c(\"CD8 TEM\", \"TEMRA\"),\n    Tfh=\"CD4 TCM TFH\",\n    Treg=\"CD4 TREG\",\n    Tp=\"Cycling T\",\n    Thn=\"CD4 TN\",\n    Tcn=\"CD8 TN\")\nnev &lt;- setNames(rep.int(names(nev), sapply(nev, length)), unlist(nev))\nlab &lt;- new[match(se$nkt$ident, old)]\nlab &lt;- nev[match(lab, names(nev))]\ntable(se$nkt$lab &lt;- lab, exclude=NULL)\n\n\nNK/ILC     Tc    Tcm    Tcn    Tex    Tfh    Thn     Tp   Treg   &lt;NA&gt; \n 31217  22652   5570   4312  24062  25102  21647   2900  12270  24945 \n\n\n\n\n\n\ngs &lt;- Reduce(intersect, lapply(se, rownames))\nmx &lt;- do.call(cbind, lapply(se, \\(.) assay(.)[gs, ]))\ndim(mx &lt;- normalizeCounts(mx, log=FALSE))\n\n[1]  36190 373988\n\n\n\n\n\n\n\n\nid &lt;- rep.int(names(se), sapply(se, ncol))\npb &lt;- summarizeAssayByGroup(mx, id, statistics=\"mean\")\nhead(pb &lt;- assay(pb))\n\n                     mye          nkt          tum\nMIR1302-2HG 0.000000e+00 5.128928e-06 6.104829e-05\nFAM138A     0.000000e+00 0.000000e+00 0.000000e+00\nOR4F5       0.000000e+00 0.000000e+00 0.000000e+00\nAL627309.1  2.167347e-03 8.358290e-04 1.458888e-03\nAL627309.3  2.226803e-05 2.605354e-05 4.804775e-05\nAL627309.2  5.940144e-05 0.000000e+00 0.000000e+00\n\n\n\n\n\n\nqb &lt;- lapply(se, \\(.) {\n    if (is.null(id &lt;- .$lab)) return()\n    cs &lt;- colnames(.)[!(ex &lt;- is.na(id))]\n    summarizeAssayByGroup(mx[, cs], id[!ex], statistics=\"mean\")\n})\nqb &lt;- qb[!sapply(qb, is.null)]\nqb &lt;- lapply(qb, assay)\nsapply(qb, colnames)\n\n$mye\n[1] \"DC\"      \"mono.c\"  \"mono.nc\" \"pDC\"    \n\n$nkt\n[1] \"NK/ILC\" \"Tc\"     \"Tcm\"    \"Tcn\"    \"Tex\"    \"Tfh\"    \"Thn\"    \"Tp\"    \n[9] \"Treg\"  \n\n\n\n\n\n\n\n\n\nsaveRDS(pb, \"outs/pbs.rds\")\nsaveRDS(qb, \"outs/qbs.rds\")\n\n\n\n\n\n\n\nsession\n\n\n\n\n\n\nsessionInfo()\n\nR version 4.5.1 (2025-06-13)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS Sequoia 15.6.1\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Europe/Madrid\ntzcode source: internal\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] patchwork_1.3.2             ggplot2_4.0.0              \n [3] tidyr_1.3.1                 dplyr_1.1.4                \n [5] scuttle_1.18.0              SingleCellExperiment_1.30.1\n [7] SummarizedExperiment_1.38.1 Biobase_2.68.0             \n [9] GenomicRanges_1.60.0        GenomeInfoDb_1.44.3        \n[11] IRanges_2.42.0              S4Vectors_0.46.0           \n[13] BiocGenerics_0.54.1         generics_0.1.4             \n[15] MatrixGenerics_1.20.0       matrixStats_1.5.0          \n[17] Seurat_5.3.1                SeuratObject_5.2.0         \n[19] sp_2.2-0                    qs_0.27.3                  \n\nloaded via a namespace (and not attached):\n  [1] RColorBrewer_1.1-3      rstudioapi_0.17.1       jsonlite_2.0.0         \n  [4] magrittr_2.0.4          spatstat.utils_3.2-0    farver_2.1.2           \n  [7] rmarkdown_2.30          vctrs_0.6.5             ROCR_1.0-11            \n [10] spatstat.explore_3.5-3  S4Arrays_1.8.1          htmltools_0.5.8.1      \n [13] SparseArray_1.8.1       sctransform_0.4.2       parallelly_1.45.1      \n [16] KernSmooth_2.23-26      htmlwidgets_1.6.4       ica_1.0-3              \n [19] plyr_1.8.9              plotly_4.11.0           zoo_1.8-14             \n [22] igraph_2.2.1            mime_0.13               lifecycle_1.0.4        \n [25] pkgconfig_2.0.3         Matrix_1.7-4            R6_2.6.1               \n [28] fastmap_1.2.0           GenomeInfoDbData_1.2.14 fitdistrplus_1.2-4     \n [31] future_1.67.0           shiny_1.11.1            digest_0.6.37          \n [34] colorspace_2.1-2        tensor_1.5.1            RSpectra_0.16-2        \n [37] irlba_2.3.5.1           beachmat_2.24.0         progressr_0.17.0       \n [40] spatstat.sparse_3.1-0   httr_1.4.7              polyclip_1.10-7        \n [43] abind_1.4-8             compiler_4.5.1          withr_3.0.2            \n [46] S7_0.2.0                BiocParallel_1.42.2     fastDummies_1.7.5      \n [49] maps_3.4.3              MASS_7.3-65             DelayedArray_0.34.1    \n [52] tools_4.5.1             lmtest_0.9-40           otel_0.2.0             \n [55] httpuv_1.6.16           future.apply_1.20.0     goftest_1.2-3          \n [58] glue_1.8.0              nlme_3.1-168            promises_1.5.0         \n [61] grid_4.5.1              Rtsne_0.17              cluster_2.1.8.1        \n [64] reshape2_1.4.4          gtable_0.3.6            spatstat.data_3.1-9    \n [67] data.table_1.17.8       RApiSerialize_0.1.4     stringfish_0.17.0      \n [70] XVector_0.48.0          spatstat.geom_3.6-0     RcppAnnoy_0.0.22       \n [73] ggrepel_0.9.6           RANN_2.6.2              pillar_1.11.1          \n [76] stringr_1.5.2           pals_1.10               spam_2.11-1            \n [79] RcppHNSW_0.6.0          later_1.4.4             splines_4.5.1          \n [82] lattice_0.22-7          survival_3.8-3          deldir_2.0-4           \n [85] tidyselect_1.2.1        miniUI_0.1.2            pbapply_1.7-4          \n [88] knitr_1.50              gridExtra_2.3           scattermore_1.2        \n [91] xfun_0.54               stringi_1.8.7           UCSC.utils_1.4.0       \n [94] lazyeval_0.2.2          yaml_2.3.10             evaluate_1.0.5         \n [97] codetools_0.2-20        tibble_3.3.0            cli_3.6.5              \n[100] uwot_0.2.3              RcppParallel_5.1.11-1   xtable_1.8-4           \n[103] reticulate_1.44.0       dichromat_2.0-0.1       Rcpp_1.1.0             \n[106] globals_0.18.0          spatstat.random_3.4-2   mapproj_1.2.12         \n[109] png_0.1-8               spatstat.univar_3.1-4   parallel_4.5.1         \n[112] dotCall64_1.2           listenv_0.10.0          viridisLite_0.4.2      \n[115] scales_1.4.0            ggridges_0.5.7          crayon_1.5.3           \n[118] purrr_1.1.0             rlang_1.1.6             cowplot_1.2.0"
  },
  {
    "objectID": "code/00-ref.html#preamble",
    "href": "code/00-ref.html#preamble",
    "title": "ref",
    "section": "",
    "text": "library(qs)\nlibrary(Seurat)\nlibrary(scuttle)\nlibrary(SingleCellExperiment)\nsource(\"code/_utils.R\")"
  },
  {
    "objectID": "code/00-ref.html#loading",
    "href": "code/00-ref.html#loading",
    "title": "ref",
    "section": "",
    "text": "qs &lt;- list.files(\"data/ref\", \"qs$\", full.names=TRUE)\nnames(qs) &lt;- gsub(\"\\\\.qs\", \"\", basename(qs))\nse &lt;- lapply(qs, \\(.) {\n    so &lt;- qread(.)\n    se &lt;- as.SingleCellExperiment(so)\n    logcounts(se) &lt;- NULL\n    reducedDims(se) &lt;- list()\n    gs &lt;- VariableFeatures(so)\n    gs &lt;- rownames(se) %in% gs\n    rowData(se)$hvg &lt;- gs\n    se\n}); sapply(se, ncol)\n\n   mye    nkt    tum \n 48047 174677 151264"
  },
  {
    "objectID": "code/00-ref.html#labeling",
    "href": "code/00-ref.html#labeling",
    "title": "ref",
    "section": "",
    "text": "old &lt;- c(\"0\",\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"10\",\"11\")\nnew &lt;- c(\n    \"Classical_monocytes\", \"Class. monocytes_HLA\", \n    \"Non-class. monocytes\", \"Class. monocytes_SELL\", \n    \"Class. monocytes_ribo\", \"DC2\", \"Class. monocytes_IFNresp\", \n    \"pDC_1\", \"Progenitor cells\", \"Platelets\", \"pDC_2\", \"DC1\")\nnev &lt;- list(\n    mono.c=c(\"Classical_monocytes\",\n        \"Class. monocytes_SELL\", \"Class. monocytes_HLA\",\n        \"Class. monocytes_ribo\", \"Class. monocytes_IFNresp\"),\n    mono.nc=\"Non-class. monocytes\",\n    pDC=c(\"pDC_2\", \"pDC_1\"),\n    DC=c(\"DC1\", \"DC2\"))\nnev &lt;- setNames(rep.int(names(nev), sapply(nev, length)), unlist(nev))\nlab &lt;- new[match(se$mye$ident, old)]\nlab &lt;- nev[match(lab, names(nev))]\ntable(se$mye$lab &lt;- lab, exclude=NULL)\n\n\n     DC  mono.c mono.nc     pDC    &lt;NA&gt; \n   3141   32819    8632    2230    1225 \n\n\n\nold &lt;- c(\"0\",\"1\",\"2\",\"3\",\"4\",\"5\",\"6\",\"7\",\"8\",\"9\",\"11\",\"12\",\"13\",\"14\",\"15\",\"17\",\"18\")\nnew &lt;- c(\n    \"CD16pos NK\",\"CD4 TCM TFH\",\"TEMRA\",\"CD4 TN\",\"CD8 TPEX\",\"CD4 TREG\",\n    \"CD4 TCM TH2\",\"NK-like T\",\"NK/ILC\",\"CD8 TEX\",\"CD4 TCM\",\"CD8 TEM\",\n    \"CD16neg NK\",\"CD8 TN\",\"MAIT\",\"Cycling T\",\"IFN responding\")\nnev &lt;- list(\n    \"NK/ILC\"=c(\"CD16neg NK\", \"CD16pos NK\", \"NK ILC3\"),\n    Tcm=c(\"CD4 TCM_TH2\", \"CD4 TCM\"),\n    Tex=c(\"CD8 TPEX\", \"CD8 TEX\"),\n    Tc=c(\"CD8 TEM\", \"TEMRA\"),\n    Tfh=\"CD4 TCM TFH\",\n    Treg=\"CD4 TREG\",\n    Tp=\"Cycling T\",\n    Thn=\"CD4 TN\",\n    Tcn=\"CD8 TN\")\nnev &lt;- setNames(rep.int(names(nev), sapply(nev, length)), unlist(nev))\nlab &lt;- new[match(se$nkt$ident, old)]\nlab &lt;- nev[match(lab, names(nev))]\ntable(se$nkt$lab &lt;- lab, exclude=NULL)\n\n\nNK/ILC     Tc    Tcm    Tcn    Tex    Tfh    Thn     Tp   Treg   &lt;NA&gt; \n 31217  22652   5570   4312  24062  25102  21647   2900  12270  24945"
  },
  {
    "objectID": "code/00-ref.html#pooling",
    "href": "code/00-ref.html#pooling",
    "title": "ref",
    "section": "",
    "text": "gs &lt;- Reduce(intersect, lapply(se, rownames))\nmx &lt;- do.call(cbind, lapply(se, \\(.) assay(.)[gs, ]))\ndim(mx &lt;- normalizeCounts(mx, log=FALSE))\n\n[1]  36190 373988"
  },
  {
    "objectID": "code/00-ref.html#profiles",
    "href": "code/00-ref.html#profiles",
    "title": "ref",
    "section": "",
    "text": "id &lt;- rep.int(names(se), sapply(se, ncol))\npb &lt;- summarizeAssayByGroup(mx, id, statistics=\"mean\")\nhead(pb &lt;- assay(pb))\n\n                     mye          nkt          tum\nMIR1302-2HG 0.000000e+00 5.128928e-06 6.104829e-05\nFAM138A     0.000000e+00 0.000000e+00 0.000000e+00\nOR4F5       0.000000e+00 0.000000e+00 0.000000e+00\nAL627309.1  2.167347e-03 8.358290e-04 1.458888e-03\nAL627309.3  2.226803e-05 2.605354e-05 4.804775e-05\nAL627309.2  5.940144e-05 0.000000e+00 0.000000e+00\n\n\n\n\n\n\nqb &lt;- lapply(se, \\(.) {\n    if (is.null(id &lt;- .$lab)) return()\n    cs &lt;- colnames(.)[!(ex &lt;- is.na(id))]\n    summarizeAssayByGroup(mx[, cs], id[!ex], statistics=\"mean\")\n})\nqb &lt;- qb[!sapply(qb, is.null)]\nqb &lt;- lapply(qb, assay)\nsapply(qb, colnames)\n\n$mye\n[1] \"DC\"      \"mono.c\"  \"mono.nc\" \"pDC\"    \n\n$nkt\n[1] \"NK/ILC\" \"Tc\"     \"Tcm\"    \"Tcn\"    \"Tex\"    \"Tfh\"    \"Thn\"    \"Tp\"    \n[9] \"Treg\""
  },
  {
    "objectID": "code/00-ref.html#appendix",
    "href": "code/00-ref.html#appendix",
    "title": "ref",
    "section": "",
    "text": "saveRDS(pb, \"outs/pbs.rds\")\nsaveRDS(qb, \"outs/qbs.rds\")\n\n\n\n\n\n\n\nsession\n\n\n\n\n\n\nsessionInfo()\n\nR version 4.5.1 (2025-06-13)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS Sequoia 15.6.1\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Europe/Madrid\ntzcode source: internal\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] patchwork_1.3.2             ggplot2_4.0.0              \n [3] tidyr_1.3.1                 dplyr_1.1.4                \n [5] scuttle_1.18.0              SingleCellExperiment_1.30.1\n [7] SummarizedExperiment_1.38.1 Biobase_2.68.0             \n [9] GenomicRanges_1.60.0        GenomeInfoDb_1.44.3        \n[11] IRanges_2.42.0              S4Vectors_0.46.0           \n[13] BiocGenerics_0.54.1         generics_0.1.4             \n[15] MatrixGenerics_1.20.0       matrixStats_1.5.0          \n[17] Seurat_5.3.1                SeuratObject_5.2.0         \n[19] sp_2.2-0                    qs_0.27.3                  \n\nloaded via a namespace (and not attached):\n  [1] RColorBrewer_1.1-3      rstudioapi_0.17.1       jsonlite_2.0.0         \n  [4] magrittr_2.0.4          spatstat.utils_3.2-0    farver_2.1.2           \n  [7] rmarkdown_2.30          vctrs_0.6.5             ROCR_1.0-11            \n [10] spatstat.explore_3.5-3  S4Arrays_1.8.1          htmltools_0.5.8.1      \n [13] SparseArray_1.8.1       sctransform_0.4.2       parallelly_1.45.1      \n [16] KernSmooth_2.23-26      htmlwidgets_1.6.4       ica_1.0-3              \n [19] plyr_1.8.9              plotly_4.11.0           zoo_1.8-14             \n [22] igraph_2.2.1            mime_0.13               lifecycle_1.0.4        \n [25] pkgconfig_2.0.3         Matrix_1.7-4            R6_2.6.1               \n [28] fastmap_1.2.0           GenomeInfoDbData_1.2.14 fitdistrplus_1.2-4     \n [31] future_1.67.0           shiny_1.11.1            digest_0.6.37          \n [34] colorspace_2.1-2        tensor_1.5.1            RSpectra_0.16-2        \n [37] irlba_2.3.5.1           beachmat_2.24.0         progressr_0.17.0       \n [40] spatstat.sparse_3.1-0   httr_1.4.7              polyclip_1.10-7        \n [43] abind_1.4-8             compiler_4.5.1          withr_3.0.2            \n [46] S7_0.2.0                BiocParallel_1.42.2     fastDummies_1.7.5      \n [49] maps_3.4.3              MASS_7.3-65             DelayedArray_0.34.1    \n [52] tools_4.5.1             lmtest_0.9-40           otel_0.2.0             \n [55] httpuv_1.6.16           future.apply_1.20.0     goftest_1.2-3          \n [58] glue_1.8.0              nlme_3.1-168            promises_1.5.0         \n [61] grid_4.5.1              Rtsne_0.17              cluster_2.1.8.1        \n [64] reshape2_1.4.4          gtable_0.3.6            spatstat.data_3.1-9    \n [67] data.table_1.17.8       RApiSerialize_0.1.4     stringfish_0.17.0      \n [70] XVector_0.48.0          spatstat.geom_3.6-0     RcppAnnoy_0.0.22       \n [73] ggrepel_0.9.6           RANN_2.6.2              pillar_1.11.1          \n [76] stringr_1.5.2           pals_1.10               spam_2.11-1            \n [79] RcppHNSW_0.6.0          later_1.4.4             splines_4.5.1          \n [82] lattice_0.22-7          survival_3.8-3          deldir_2.0-4           \n [85] tidyselect_1.2.1        miniUI_0.1.2            pbapply_1.7-4          \n [88] knitr_1.50              gridExtra_2.3           scattermore_1.2        \n [91] xfun_0.54               stringi_1.8.7           UCSC.utils_1.4.0       \n [94] lazyeval_0.2.2          yaml_2.3.10             evaluate_1.0.5         \n [97] codetools_0.2-20        tibble_3.3.0            cli_3.6.5              \n[100] uwot_0.2.3              RcppParallel_5.1.11-1   xtable_1.8-4           \n[103] reticulate_1.44.0       dichromat_2.0-0.1       Rcpp_1.1.0             \n[106] globals_0.18.0          spatstat.random_3.4-2   mapproj_1.2.12         \n[109] png_0.1-8               spatstat.univar_3.1-4   parallel_4.5.1         \n[112] dotCall64_1.2           listenv_0.10.0          viridisLite_0.4.2      \n[115] scales_1.4.0            ggridges_0.5.7          crayon_1.5.3           \n[118] purrr_1.1.0             rlang_1.1.6             cowplot_1.2.0"
  },
  {
    "objectID": "code/00-raw.html",
    "href": "code/00-raw.html",
    "title": "raw",
    "section": "",
    "text": "library(arrow)\nlibrary(dplyr)\nlibrary(Matrix)\nlibrary(SparseArray)\nlibrary(SingleCellExperiment)\nsource(\"code/_utils.R\")\n\n\n# add local & global coordinates in mm\n.mm &lt;- \\(df, px=\".*_(local|global)_(px)\") {\n    px &lt;- grep(px, names(df))\n    mm &lt;- sapply(df[px], .px2mm)\n    nm &lt;- gsub(\"px$\", \"mm\", colnames(mm))\n    colnames(mm) &lt;- nm; cbind(df, mm)\n}\n\n\n\n\n\n# construct SCE from transcript counts & cell metadata\ncd &lt;- .mm(read.csv(\"data/raw/metadata.csv\"))\nmx &lt;- readSparseCSV(\"data/raw/counts.csv\", transpose=TRUE)\nmy &lt;- `colnames&lt;-`(as(mx[-1, ], \"dgCMatrix\"), cd$cell)\n(sce &lt;- SingleCellExperiment(list(counts=my), colData=cd))\n\nclass: SingleCellExperiment \ndim: 6720 441984 \nmetadata(0):\nassays(1): counts\nrownames(6720): A1BG A2M ... SystemControl98 SystemControl99\nrowData names(0):\ncolnames(441984): c_1_1_1 c_1_1_2 ... c_1_364_1966 c_1_364_1967\ncolData names(64): cell nCount_RNA ... CenterX_global_mm\n  CenterY_global_mm\nreducedDimNames(0):\nmainExpName: NULL\naltExpNames(0):\n\n\n\n\n\n\n\n\n# move negative probe & blank code data to 'altExps'\nnames(gs) &lt;- gs &lt;- c(\"Negative\", \"SystemControl\")\ngs &lt;- lapply(gs, grep, rownames(sce))\naltExps(sce) &lt;- lapply(gs, \\(.) sce[., ])\nsce &lt;- sce[-unlist(gs), ]\nsapply(gs, length)\n\n     Negative SystemControl \n           21           324 \n\n\n\n\n\n\n# add core-level metadata\nmd &lt;- read.csv(\"data/raw/mapping.csv\")\nmd &lt;- md[md$biopsy_site != \"TO\", ]\nsub &lt;- sce[, sce$fov %in% md$fov]\ni &lt;- match(sub$fov, md$fov)\nj &lt;- setdiff(names(md), names(colData(sub)))\ncolData(sub) &lt;- cbind(colData(sub), md[i, j])\ncat(\"genes: \", nrow(sub), \"; \", sep=\"\", \n    \"cells: \", ncol(sub), \"/\", ncol(sce))\n\ngenes: 6375; cells: 105174/441984\n\n\n\n\n\n\n# prepare polygons\npol &lt;- read.csv(\"data/raw/polygons.csv\")\npol &lt;- filter(pol, cell %in% colnames(sub))\nat &lt;- arrow_table(.mm(pol))\n\n\n\n\n\n# streamline identifiers\nfoo &lt;- c(n=\"MCLN\", m=\"MCLMZ\", d=\"MCLD\")\nns &lt;- rowSums(tbl &lt;- table(sub$core, sub$roi) &gt; 1)\nns &lt;- lapply(ns, \\(.) if (. == 1) 0 else seq(.))\nsub$roi &lt;- factor(unlist(ns)[match(sub$roi, colnames(tbl))])\nsub$gid &lt;- factor(sub$pathology, foo, names(foo))\nsub$pid &lt;- factor(sprintf(\"%02d\", as.integer(factor(sub$core))))\nsub$typ &lt;- factor(ifelse((. &lt;- sub$biopsy_site) == \"EYE\", \"EY\", .))\ntable(sub$sid &lt;- paste0(sub$pid, sub$roi, sub$typ, sub$gid), sub$typ)\n\n        \n           EY   LN   NP   SO\n  011LNd    0 4969    0    0\n  012LNd    0 5695    0    0\n  020LNm    0 2449    0    0\n  031LNd    0 7357    0    0\n  032LNd    0 4836    0    0\n  041SOd    0    0    0 3694\n  042SOd    0    0    0 4391\n  051LNn    0 7613    0    0\n  052LNn    0 6241    0    0\n  061LNd    0 4338    0    0\n  062LNd    0 3974    0    0\n  071NPd    0    0 3743    0\n  072NPd    0    0 6578    0\n  080LNn    0 5480    0    0\n  091EYn 2129    0    0    0\n  092EYn 1325    0    0    0\n  100LNd    0 3527    0    0\n  111LNn    0 4587    0    0\n  112LNn    0 4045    0    0\n  121LNm    0 9003    0    0\n  122LNm    0 9200    0    0\n\n\n\n\n\n\n\n\n\nsaveRDS(sub, \"outs/raw.rds\")\n\n\n\n\n\n\n\nsession\n\n\n\n\n\n\nsessionInfo()\n\nR version 4.5.1 (2025-06-13)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS Sequoia 15.6.1\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Europe/Madrid\ntzcode source: internal\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] patchwork_1.3.2             ggplot2_4.0.0              \n [3] tidyr_1.3.1                 SingleCellExperiment_1.30.1\n [5] SummarizedExperiment_1.38.1 Biobase_2.68.0             \n [7] GenomicRanges_1.60.0        GenomeInfoDb_1.44.3        \n [9] SparseArray_1.8.1           S4Arrays_1.8.1             \n[11] IRanges_2.42.0              abind_1.4-8                \n[13] S4Vectors_0.46.0            MatrixGenerics_1.20.0      \n[15] matrixStats_1.5.0           BiocGenerics_0.54.1        \n[17] generics_0.1.4              Matrix_1.7-4               \n[19] dplyr_1.1.4                 arrow_22.0.0               \n\nloaded via a namespace (and not attached):\n [1] gtable_0.3.6            xfun_0.54               htmlwidgets_1.6.4      \n [4] lattice_0.22-7          vctrs_0.6.5             tools_4.5.1            \n [7] tibble_3.3.0            pkgconfig_2.0.3         RColorBrewer_1.1-3     \n[10] S7_0.2.0                pals_1.10               assertthat_0.2.1       \n[13] lifecycle_1.0.4         GenomeInfoDbData_1.2.14 compiler_4.5.1         \n[16] farver_2.1.2            mapproj_1.2.12          htmltools_0.5.8.1      \n[19] maps_3.4.3              yaml_2.3.10             pillar_1.11.1          \n[22] crayon_1.5.3            DelayedArray_0.34.1     tidyselect_1.2.1       \n[25] digest_0.6.37           purrr_1.1.0             fastmap_1.2.0          \n[28] grid_4.5.1              colorspace_2.1-2        cli_3.6.5              \n[31] magrittr_2.0.4          dichromat_2.0-0.1       withr_3.0.2            \n[34] UCSC.utils_1.4.0        scales_1.4.0            bit64_4.6.0-1          \n[37] rmarkdown_2.30          XVector_0.48.0          httr_1.4.7             \n[40] bit_4.6.0               evaluate_1.0.5          knitr_1.50             \n[43] rlang_1.1.6             glue_1.8.0              rstudioapi_0.17.1      \n[46] jsonlite_2.0.0          R6_2.6.1"
  },
  {
    "objectID": "code/00-raw.html#preamble",
    "href": "code/00-raw.html#preamble",
    "title": "raw",
    "section": "",
    "text": "library(arrow)\nlibrary(dplyr)\nlibrary(Matrix)\nlibrary(SparseArray)\nlibrary(SingleCellExperiment)\nsource(\"code/_utils.R\")\n\n\n# add local & global coordinates in mm\n.mm &lt;- \\(df, px=\".*_(local|global)_(px)\") {\n    px &lt;- grep(px, names(df))\n    mm &lt;- sapply(df[px], .px2mm)\n    nm &lt;- gsub(\"px$\", \"mm\", colnames(mm))\n    colnames(mm) &lt;- nm; cbind(df, mm)\n}"
  },
  {
    "objectID": "code/00-raw.html#loading",
    "href": "code/00-raw.html#loading",
    "title": "raw",
    "section": "",
    "text": "# construct SCE from transcript counts & cell metadata\ncd &lt;- .mm(read.csv(\"data/raw/metadata.csv\"))\nmx &lt;- readSparseCSV(\"data/raw/counts.csv\", transpose=TRUE)\nmy &lt;- `colnames&lt;-`(as(mx[-1, ], \"dgCMatrix\"), cd$cell)\n(sce &lt;- SingleCellExperiment(list(counts=my), colData=cd))\n\nclass: SingleCellExperiment \ndim: 6720 441984 \nmetadata(0):\nassays(1): counts\nrownames(6720): A1BG A2M ... SystemControl98 SystemControl99\nrowData names(0):\ncolnames(441984): c_1_1_1 c_1_1_2 ... c_1_364_1966 c_1_364_1967\ncolData names(64): cell nCount_RNA ... CenterX_global_mm\n  CenterY_global_mm\nreducedDimNames(0):\nmainExpName: NULL\naltExpNames(0):"
  },
  {
    "objectID": "code/00-raw.html#wrangling",
    "href": "code/00-raw.html#wrangling",
    "title": "raw",
    "section": "",
    "text": "# move negative probe & blank code data to 'altExps'\nnames(gs) &lt;- gs &lt;- c(\"Negative\", \"SystemControl\")\ngs &lt;- lapply(gs, grep, rownames(sce))\naltExps(sce) &lt;- lapply(gs, \\(.) sce[., ])\nsce &lt;- sce[-unlist(gs), ]\nsapply(gs, length)\n\n     Negative SystemControl \n           21           324 \n\n\n\n\n\n\n# add core-level metadata\nmd &lt;- read.csv(\"data/raw/mapping.csv\")\nmd &lt;- md[md$biopsy_site != \"TO\", ]\nsub &lt;- sce[, sce$fov %in% md$fov]\ni &lt;- match(sub$fov, md$fov)\nj &lt;- setdiff(names(md), names(colData(sub)))\ncolData(sub) &lt;- cbind(colData(sub), md[i, j])\ncat(\"genes: \", nrow(sub), \"; \", sep=\"\", \n    \"cells: \", ncol(sub), \"/\", ncol(sce))\n\ngenes: 6375; cells: 105174/441984\n\n\n\n\n\n\n# prepare polygons\npol &lt;- read.csv(\"data/raw/polygons.csv\")\npol &lt;- filter(pol, cell %in% colnames(sub))\nat &lt;- arrow_table(.mm(pol))\n\n\n\n\n\n# streamline identifiers\nfoo &lt;- c(n=\"MCLN\", m=\"MCLMZ\", d=\"MCLD\")\nns &lt;- rowSums(tbl &lt;- table(sub$core, sub$roi) &gt; 1)\nns &lt;- lapply(ns, \\(.) if (. == 1) 0 else seq(.))\nsub$roi &lt;- factor(unlist(ns)[match(sub$roi, colnames(tbl))])\nsub$gid &lt;- factor(sub$pathology, foo, names(foo))\nsub$pid &lt;- factor(sprintf(\"%02d\", as.integer(factor(sub$core))))\nsub$typ &lt;- factor(ifelse((. &lt;- sub$biopsy_site) == \"EYE\", \"EY\", .))\ntable(sub$sid &lt;- paste0(sub$pid, sub$roi, sub$typ, sub$gid), sub$typ)\n\n        \n           EY   LN   NP   SO\n  011LNd    0 4969    0    0\n  012LNd    0 5695    0    0\n  020LNm    0 2449    0    0\n  031LNd    0 7357    0    0\n  032LNd    0 4836    0    0\n  041SOd    0    0    0 3694\n  042SOd    0    0    0 4391\n  051LNn    0 7613    0    0\n  052LNn    0 6241    0    0\n  061LNd    0 4338    0    0\n  062LNd    0 3974    0    0\n  071NPd    0    0 3743    0\n  072NPd    0    0 6578    0\n  080LNn    0 5480    0    0\n  091EYn 2129    0    0    0\n  092EYn 1325    0    0    0\n  100LNd    0 3527    0    0\n  111LNn    0 4587    0    0\n  112LNn    0 4045    0    0\n  121LNm    0 9003    0    0\n  122LNm    0 9200    0    0"
  },
  {
    "objectID": "code/00-raw.html#appendix",
    "href": "code/00-raw.html#appendix",
    "title": "raw",
    "section": "",
    "text": "saveRDS(sub, \"outs/raw.rds\")\n\n\n\n\n\n\n\nsession\n\n\n\n\n\n\nsessionInfo()\n\nR version 4.5.1 (2025-06-13)\nPlatform: aarch64-apple-darwin20\nRunning under: macOS Sequoia 15.6.1\n\nMatrix products: default\nBLAS:   /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRblas.0.dylib \nLAPACK: /Library/Frameworks/R.framework/Versions/4.5-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.1\n\nlocale:\n[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8\n\ntime zone: Europe/Madrid\ntzcode source: internal\n\nattached base packages:\n[1] stats4    stats     graphics  grDevices utils     datasets  methods  \n[8] base     \n\nother attached packages:\n [1] patchwork_1.3.2             ggplot2_4.0.0              \n [3] tidyr_1.3.1                 SingleCellExperiment_1.30.1\n [5] SummarizedExperiment_1.38.1 Biobase_2.68.0             \n [7] GenomicRanges_1.60.0        GenomeInfoDb_1.44.3        \n [9] SparseArray_1.8.1           S4Arrays_1.8.1             \n[11] IRanges_2.42.0              abind_1.4-8                \n[13] S4Vectors_0.46.0            MatrixGenerics_1.20.0      \n[15] matrixStats_1.5.0           BiocGenerics_0.54.1        \n[17] generics_0.1.4              Matrix_1.7-4               \n[19] dplyr_1.1.4                 arrow_22.0.0               \n\nloaded via a namespace (and not attached):\n [1] gtable_0.3.6            xfun_0.54               htmlwidgets_1.6.4      \n [4] lattice_0.22-7          vctrs_0.6.5             tools_4.5.1            \n [7] tibble_3.3.0            pkgconfig_2.0.3         RColorBrewer_1.1-3     \n[10] S7_0.2.0                pals_1.10               assertthat_0.2.1       \n[13] lifecycle_1.0.4         GenomeInfoDbData_1.2.14 compiler_4.5.1         \n[16] farver_2.1.2            mapproj_1.2.12          htmltools_0.5.8.1      \n[19] maps_3.4.3              yaml_2.3.10             pillar_1.11.1          \n[22] crayon_1.5.3            DelayedArray_0.34.1     tidyselect_1.2.1       \n[25] digest_0.6.37           purrr_1.1.0             fastmap_1.2.0          \n[28] grid_4.5.1              colorspace_2.1-2        cli_3.6.5              \n[31] magrittr_2.0.4          dichromat_2.0-0.1       withr_3.0.2            \n[34] UCSC.utils_1.4.0        scales_1.4.0            bit64_4.6.0-1          \n[37] rmarkdown_2.30          XVector_0.48.0          httr_1.4.7             \n[40] bit_4.6.0               evaluate_1.0.5          knitr_1.50             \n[43] rlang_1.1.6             glue_1.8.0              rstudioapi_0.17.1      \n[46] jsonlite_2.0.0          R6_2.6.1"
  }
]